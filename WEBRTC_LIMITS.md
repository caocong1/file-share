# WebRTC 数据通道消息大小限制

## 为什么 256KB 是一个硬限制？

您发现的这个现象非常准确！WebRTC 数据通道确实有一个 **256KB (262,144 字节)** 的单个消息大小限制。

### 技术原因

1. **SCTP 协议限制**
   - WebRTC 数据通道使用 SCTP (Stream Control Transmission Protocol)
   - SCTP 的默认最大消息大小是 256KB
   - 这是协议层面的限制，不是浏览器的限制

2. **为什么正好是 256KB？**
   - 256KB = 262,144 字节 = 2^18 字节
   - 这是一个计算机友好的数字（2 的幂次方）
   - 早期 SCTP 实现选择了这个值作为合理的平衡点

3. **实际可用大小**
   - 由于协议开销，实际可用大小略小于 256KB
   - 建议使用最大 255KB 以确保安全

## 解决方案

### 方案 1：保持块大小 ≤ 256KB（推荐）
```javascript
config.options = {
  chunkSize: 256 * 1024,  // 正好 256KB
  // 或者
  chunkSize: 255 * 1024,  // 255KB，更安全
}
```

### 方案 2：大块自动分片
如果您需要使用更大的块（如 1MB），可以在发送时自动分片：

```javascript
// 已在代码中实现
const MAX_MESSAGE_SIZE = 256 * 1024
if (buffer.byteLength > MAX_MESSAGE_SIZE) {
  // 分成多个 256KB 的片段发送
}
```

## 性能影响

### 256KB 块大小的优势
1. **最大化单次传输**：充分利用协议限制
2. **减少开销**：相比小块，减少了消息头开销
3. **良好的平衡**：在效率和灵活性之间取得平衡

### 并发数建议
- 256KB 块：建议 5-10 个并发
- 128KB 块：建议 10-20 个并发
- 64KB 块：建议 20-40 个并发

## 不同浏览器的表现

虽然 256KB 是标准限制，但不同浏览器的处理方式略有不同：

- **Chrome/Edge**：严格执行 256KB 限制
- **Firefox**：同样执行 256KB 限制
- **Safari**：可能有轻微差异，但基本相同

## 最佳实践

1. **使用 256KB 或略小的块大小**
   - 最大化传输效率
   - 避免分片的复杂性

2. **根据网络调整并发数**
   - 局域网：10-15 个并发
   - 广域网：5-10 个并发

3. **监控缓冲区**
   - 总缓冲 = 块大小 × 并发数
   - 保持总缓冲 < 16MB

## 常见错误

如果块大小 > 256KB，可能看到的错误：
- `OperationError: Failed to execute 'send' on 'RTCDataChannel'`
- `RTCDataChannel send queue is full`
- `Failure to send data`

这些错误都指向同一个问题：尝试发送的消息超过了协议限制。 