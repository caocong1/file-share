# P2P æ–‡ä»¶ä¼ è¾“åº”ç”¨ - ä½¿ç”¨è¯´æ˜

## ğŸš€ å¿«é€Ÿå¯åŠ¨

### 1. å®‰è£…ä¾èµ–
```bash
# ä½¿ç”¨ pnpmï¼ˆæ¨èï¼‰
pnpm install

# æˆ–ä½¿ç”¨ npm
npm install
```

### 2. å¯åŠ¨åº”ç”¨
```bash
# åŒæ—¶å¯åŠ¨ Web æœåŠ¡å™¨å’Œ WebSocket ä¿¡ä»¤æœåŠ¡å™¨
npm start

# æˆ–ä½¿ç”¨å¼€å‘æ¨¡å¼ï¼ˆå¸¦é¢œè‰²è¾“å‡ºï¼‰
npm run dev
```

### 3. è®¿é—®åº”ç”¨
æ‰“å¼€æµè§ˆå™¨è®¿é—®ï¼š**http://localhost:3000**

## ğŸ“‹ å¯ç”¨è„šæœ¬

### å¼€å‘æ¨¡å¼
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `npm start` | åŒæ—¶å¯åŠ¨ Web æœåŠ¡å™¨(3000) å’Œä¿¡ä»¤æœåŠ¡å™¨(3001) |
| `npm run dev` | å¼€å‘æ¨¡å¼å¯åŠ¨ï¼Œå¸¦é¢œè‰²æ ‡è¯†çš„æ—¥å¿—è¾“å‡º |
| `npm run web` | ä»…å¯åŠ¨ Web æœåŠ¡å™¨ (ç«¯å£ 3000) |
| `npm run signal` | ä»…å¯åŠ¨ WebSocket ä¿¡ä»¤æœåŠ¡å™¨ (ç«¯å£ 3001) |

### PM2 ç”Ÿäº§æ¨¡å¼
| å‘½ä»¤ | è¯´æ˜ |
|------|------|
| `npm run prod` | ç”Ÿäº§æ¨¡å¼å¯åŠ¨ï¼ˆä½¿ç”¨ PM2ï¼‰ |
| `npm run pm2:start` | å¯åŠ¨ PM2 åº”ç”¨ |
| `npm run pm2:stop` | åœæ­¢ PM2 åº”ç”¨ |
| `npm run pm2:restart` | é‡å¯ PM2 åº”ç”¨ |
| `npm run pm2:reload` | æ— ç¼é‡è½½ PM2 åº”ç”¨ |
| `npm run pm2:delete` | åˆ é™¤ PM2 åº”ç”¨ |
| `npm run pm2:logs` | æŸ¥çœ‹ PM2 æ—¥å¿— |
| `npm run pm2:status` | æŸ¥çœ‹ PM2 çŠ¶æ€ |
| `npm run pm2:monit` | PM2 ç›‘æ§ç•Œé¢ |
| `npm run pm2:dev` | PM2 å¼€å‘æ¨¡å¼ï¼ˆå¸¦æ–‡ä»¶ç›‘æ§ï¼‰ |

## ğŸ”§ æœåŠ¡å™¨é…ç½®

### ç«¯å£é…ç½®
- **Web æœåŠ¡å™¨**: é»˜è®¤ç«¯å£ 3000
- **ä¿¡ä»¤æœåŠ¡å™¨**: é»˜è®¤ç«¯å£ 3001

å¯ä»¥é€šè¿‡ç¯å¢ƒå˜é‡è‡ªå®šä¹‰ç«¯å£ï¼š
```bash
# è‡ªå®šä¹‰ Web æœåŠ¡å™¨ç«¯å£
WEB_PORT=8080 npm run web

# è‡ªå®šä¹‰ä¿¡ä»¤æœåŠ¡å™¨ç«¯å£
PORT=8001 npm run signal

# è‡ªå®šä¹‰ä¸»æœºåœ°å€
HOST=0.0.0.0 npm start
```

### è·¨è®¾å¤‡è¿æ¥
å¦‚æœéœ€è¦å±€åŸŸç½‘å†…å…¶ä»–è®¾å¤‡è®¿é—®ï¼š

1. è·å–æœ¬æœº IP åœ°å€
2. ä½¿ç”¨ IP åœ°å€è®¿é—®ï¼š`http://192.168.1.100:3000`
3. æˆ–é€šè¿‡ URL å‚æ•°æŒ‡å®šä¿¡ä»¤æœåŠ¡å™¨ï¼š
   ```
   http://192.168.1.100:3000?server=192.168.1.100:3001
   ```

## ğŸŒ åº”ç”¨æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Web Server    â”‚    â”‚  Signal Server  â”‚
â”‚   (port 3000)   â”‚    â”‚   (port 3001)   â”‚
â”‚                 â”‚    â”‚                 â”‚
â”‚ æä¾›é™æ€æ–‡ä»¶     â”‚    â”‚ WebSocket ä¿¡ä»¤   â”‚
â”‚ - index.html    â”‚    â”‚ - ç”¨æˆ·æ³¨å†Œ       â”‚
â”‚ - *.js          â”‚    â”‚ - åœ¨çº¿åˆ—è¡¨       â”‚
â”‚ - *.css         â”‚    â”‚ - P2P ä¿¡ä»¤è½¬å‘   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚   Browser App   â”‚
         â”‚                 â”‚
         â”‚ - P2P è¿æ¥ç®¡ç†   â”‚
         â”‚ - æ–‡ä»¶ä¼ è¾“       â”‚
         â”‚ - ç”¨æˆ·ç•Œé¢       â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ” æ•…éšœæ’é™¤

### ç«¯å£å ç”¨é—®é¢˜
å¦‚æœç«¯å£è¢«å ç”¨ï¼Œæ‚¨ä¼šçœ‹åˆ°ç±»ä¼¼é”™è¯¯ï¼š
```
âŒ Port 3000 is already in use
```

è§£å†³æ–¹æ¡ˆï¼š
```bash
# ä½¿ç”¨ä¸åŒç«¯å£
WEB_PORT=3001 npm run web

# æˆ–ç»ˆæ­¢å ç”¨ç«¯å£çš„è¿›ç¨‹
lsof -ti:3000 | xargs kill -9  # macOS/Linux
netstat -ano | findstr :3000   # Windows
```

### æ— æ³•è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨
ç¡®ä¿ä¿¡ä»¤æœåŠ¡å™¨æ­£åœ¨è¿è¡Œï¼š
```bash
# æ£€æŸ¥ä¿¡ä»¤æœåŠ¡å™¨çŠ¶æ€
curl http://localhost:3001/status
```

### è·¨è®¾å¤‡è¿æ¥é—®é¢˜
1. ç¡®ä¿è®¾å¤‡åœ¨åŒä¸€å±€åŸŸç½‘å†…
2. æ£€æŸ¥é˜²ç«å¢™è®¾ç½®
3. ä½¿ç”¨ IP åœ°å€è€Œä¸æ˜¯ localhost
4. é€šè¿‡ URL å‚æ•°æŒ‡å®šæ­£ç¡®çš„ä¿¡ä»¤æœåŠ¡å™¨åœ°å€

## ğŸ“ å¼€å‘è¯´æ˜

### æ–‡ä»¶ç»“æ„
```
file-share/
â”œâ”€â”€ index.html              # ä¸»ç•Œé¢
â”œâ”€â”€ web-server.js           # HTTP é™æ€æ–‡ä»¶æœåŠ¡å™¨
â”œâ”€â”€ ws-signal-server.js     # WebSocket ä¿¡ä»¤æœåŠ¡å™¨
â”œâ”€â”€ p2p-manager-ws.js       # P2P è¿æ¥ç®¡ç†å™¨
â”œâ”€â”€ p2p-connection.js       # P2P è¿æ¥å®ç°
â”œâ”€â”€ config.js               # é…ç½®æ–‡ä»¶
â””â”€â”€ package.json            # é¡¹ç›®é…ç½®
```

### ä¿®æ”¹é…ç½®
ç¼–è¾‘ `config.js` æ–‡ä»¶æ¥ä¿®æ”¹ï¼š
- ä¿¡ä»¤æœåŠ¡å™¨åœ°å€
- STUN æœåŠ¡å™¨è®¾ç½®
- æ–‡ä»¶ä¼ è¾“å‚æ•°
- è¿æ¥è¶…æ—¶è®¾ç½®

### è‡ªå®šä¹‰ä¸»æœºè®¿é—®
å¦‚æœéœ€è¦å±€åŸŸç½‘è®¿é—®ï¼Œå¯åŠ¨æ—¶è®¾ç½®ä¸»æœºï¼š
```bash
HOST=0.0.0.0 npm start
```

ç„¶åå…¶ä»–è®¾å¤‡å¯ä»¥é€šè¿‡æ‚¨çš„ IP åœ°å€è®¿é—®ï¼Œä¾‹å¦‚ï¼š
`http://192.168.1.100:3000`

## ğŸš€ PM2 ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### PM2 ä»‹ç»
PM2 æ˜¯ä¸€ä¸ªç”Ÿäº§çº§çš„ Node.js è¿›ç¨‹ç®¡ç†å™¨ï¼Œå…·æœ‰ä»¥ä¸‹ç‰¹æ€§ï¼š
- ğŸ”„ è‡ªåŠ¨é‡å¯
- ğŸ“Š æ€§èƒ½ç›‘æ§
- ğŸ“ æ—¥å¿—ç®¡ç†
- âš¡ é›¶åœæœºæ—¶é—´é‡è½½
- ğŸ”§ é›†ç¾¤æ¨¡å¼æ”¯æŒ

### å¿«é€Ÿå¼€å§‹
```bash
# å®‰è£… PM2ï¼ˆå¦‚æœå°šæœªå®‰è£…ï¼‰
npm install

# ç”Ÿäº§æ¨¡å¼å¯åŠ¨
npm run prod

# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
npm run pm2:status
```

### PM2 å¸¸ç”¨å‘½ä»¤

#### åº”ç”¨ç®¡ç†
```bash
# å¯åŠ¨åº”ç”¨
npm run pm2:start

# åœæ­¢åº”ç”¨
npm run pm2:stop

# é‡å¯åº”ç”¨
npm run pm2:restart

# æ— ç¼é‡è½½ï¼ˆé›¶åœæœºæ—¶é—´ï¼‰
npm run pm2:reload

# åˆ é™¤åº”ç”¨
npm run pm2:delete
```

#### ç›‘æ§å’Œæ—¥å¿—
```bash
# æŸ¥çœ‹åº”ç”¨çŠ¶æ€
npm run pm2:status

# æŸ¥çœ‹å®æ—¶æ—¥å¿—
npm run pm2:logs

# æŸ¥çœ‹ç‰¹å®šåº”ç”¨æ—¥å¿—
pm2 logs file-share-web
pm2 logs file-share-signal

# å®æ—¶ç›‘æ§ç•Œé¢
npm run pm2:monit

# æ¸…ç©ºæ—¥å¿—
pm2 flush
```

#### å¼€å‘æ¨¡å¼
```bash
# PM2 å¼€å‘æ¨¡å¼ï¼ˆè‡ªåŠ¨é‡è½½ï¼‰
npm run pm2:dev
```

### é…ç½®æ–‡ä»¶è¯´æ˜

`ecosystem.config.cjs` åŒ…å«å®Œæ•´çš„ PM2 é…ç½®ï¼š

- **åº”ç”¨é…ç½®**: ä¸¤ä¸ªåº”ç”¨å®ä¾‹ï¼ˆweb-server å’Œ signal-serverï¼‰
- **ç¯å¢ƒå˜é‡**: æ”¯æŒ development å’Œ production ç¯å¢ƒ
- **æ—¥å¿—ç®¡ç†**: è‡ªåŠ¨åˆ†ç¦»é”™è¯¯æ—¥å¿—å’Œè¾“å‡ºæ—¥å¿—
- **é‡å¯ç­–ç•¥**: è‡ªåŠ¨é‡å¯å’Œå†…å­˜é™åˆ¶
- **éƒ¨ç½²é…ç½®**: æ”¯æŒè‡ªåŠ¨åŒ–éƒ¨ç½²

### ç¯å¢ƒé…ç½®

#### ç”Ÿäº§ç¯å¢ƒ
```bash
# è®¾ç½®ç”Ÿäº§ç¯å¢ƒ
NODE_ENV=production npm run pm2:start

# æˆ–ç›´æ¥ä½¿ç”¨ç”Ÿäº§å‘½ä»¤
npm run prod
```

#### å¼€å‘ç¯å¢ƒ
```bash
# å¼€å‘ç¯å¢ƒï¼ˆå¸¦æ–‡ä»¶ç›‘æ§ï¼‰
NODE_ENV=development npm run pm2:dev
```

### æ—¥å¿—æ–‡ä»¶ä½ç½®
```
logs/
â”œâ”€â”€ web-error.log          # Web æœåŠ¡å™¨é”™è¯¯æ—¥å¿—
â”œâ”€â”€ web-out.log           # Web æœåŠ¡å™¨è¾“å‡ºæ—¥å¿—
â”œâ”€â”€ web-combined.log      # Web æœåŠ¡å™¨åˆå¹¶æ—¥å¿—
â”œâ”€â”€ signal-error.log      # ä¿¡ä»¤æœåŠ¡å™¨é”™è¯¯æ—¥å¿—
â”œâ”€â”€ signal-out.log        # ä¿¡ä»¤æœåŠ¡å™¨è¾“å‡ºæ—¥å¿—
â””â”€â”€ signal-combined.log   # ä¿¡ä»¤æœåŠ¡å™¨åˆå¹¶æ—¥å¿—
```

### æ€§èƒ½ç›‘æ§

PM2 æä¾›äº†å¼ºå¤§çš„ç›‘æ§åŠŸèƒ½ï¼š

```bash
# Web ç•Œé¢ç›‘æ§ï¼ˆéœ€è¦ PM2 Plusï¼‰
pm2 web

# å‘½ä»¤è¡Œç›‘æ§
npm run pm2:monit

# æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
pm2 show file-share-web
pm2 show file-share-signal
```

### è‡ªåŠ¨åŒ–éƒ¨ç½²

é…ç½®æ–‡ä»¶ä¸­åŒ…å«äº†éƒ¨ç½²é…ç½®ç¤ºä¾‹ï¼Œå¯ä»¥ç”¨äºï¼š
- è‡ªåŠ¨ä» Git æ‹‰å–ä»£ç 
- è‡ªåŠ¨å®‰è£…ä¾èµ–
- è‡ªåŠ¨é‡è½½åº”ç”¨

ä½¿ç”¨æ–¹æ³•ï¼š
```bash
# é¦–æ¬¡éƒ¨ç½²è®¾ç½®
pm2 deploy ecosystem.config.cjs production setup

# éƒ¨ç½²æ›´æ–°
pm2 deploy ecosystem.config.cjs production
``` 