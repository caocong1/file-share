# 故障排除指南

## 常见问题

### 0. 文件夹传输问题

#### 问题：复制文件夹后粘贴，显示"不支持粘贴文件夹"
**症状**：粘贴时弹出警告，显示检测到文件夹无法传输

**原因**：浏览器安全限制，Clipboard API 无法直接处理文件夹结构

**解决方案**：
1. **推荐方法**：将文件夹压缩为ZIP文件后传输
2. **批量选择**：进入文件夹，全选文件(Ctrl+A)，然后复制粘贴
3. **分批传输**：手动选择文件夹中的部分文件进行传输

#### 问题：拖拽文件夹没有反应
**症状**：拖拽文件夹到传输区域时弹出警告

**原因**：系统检测到文件夹并自动阻止了操作

**解决方案**：
- 打开文件夹，选择其中的文件进行拖拽
- 或使用压缩文件的方式传输

#### 问题：误把文件识别为文件夹
**症状**：某些无扩展名的文件被误判为文件夹

**解决方案**：
- 系统已优化识别逻辑，常见文件(README、LICENSE等)不会被误判
- 查看浏览器控制台的"[文件夹检测]"日志了解详情
- 为文件添加适当的扩展名可避免误判

### 1. OperationError: Failure to send data

**症状**：传输过程中报错，提示发送数据失败，数据通道关闭

**原因**：
- 网络不稳定或连接质量差
- 数据块太大，超出网络承载能力
- 缓冲区溢出
- 对端设备性能不足或网络较差

**解决方案**：
1. 系统会自动重试失败的块（最多3次）
2. 使用更小的块大小（已调整为 256KB）
3. 降低并发数（已调整为 3）
4. 检查网络连接质量
5. 如果问题持续，尝试：
   - 关闭其他占用带宽的应用
   - 靠近路由器或使用有线连接
   - 重启浏览器

### 2. RTCDataChannel.readyState is not 'open'

**症状**：选择文件后立即报错，提示数据通道未打开

**原因**：
- WebRTC 连接建立是异步的
- 数据通道需要时间来完成握手
- 可能在连接完全建立前就尝试发送数据

**解决方案**：
1. 系统会自动等待最多 5 秒让数据通道打开
2. 确保先建立连接，等待连接成功提示
3. 如果问题持续，尝试重新连接

### 3. RTCDataChannel send queue is full

**症状**：传输大文件时报错，提示发送队列已满

**原因**：
- 文件块太大
- 并发传输数太高
- 网络速度跟不上发送速度

**解决方案**：
1. 减小块大小（建议 256KB - 1MB）
2. 降低并发数（建议 3-5）
3. 检查网络连接质量

### 4. 连接失败或超时

**症状**：点击连接后长时间无响应或失败

**可能原因**：
- 防火墙阻止 WebRTC 连接
- STUN 服务器不可用
- 网络配置问题

**解决方案**：
1. 确保两个设备在同一网络
2. 检查防火墙设置
3. 尝试使用公共 STUN 服务器：
   ```javascript
   stunServer: 'stun:stun.l.google.com:19302'
   ```

### 5. 端口占用问题

**症状**：启动时报错端口被占用

**解决方案**：
```bash
# 使用不同端口
WEB_PORT=3001 npm run web

# 或终止占用端口的进程
lsof -ti:3000 | xargs kill -9  # macOS/Linux
netstat -ano | findstr :3000   # Windows
```

### 6. 无法连接到信令服务器

**症状**：界面显示连接失败或无法获取在线用户列表

**解决方案**：
```bash
# 检查信令服务器状态
curl http://localhost:3001/status

# 确保信令服务器正在运行
npm run signal
```

### 7. Chrome 浏览器无法获取本机 IP

**症状**：显示类似 `c6b9a1fa-8487-474f-9d09-c0ad1eb99a09.local` 的随机域名

**原因**：Chrome 等现代浏览器的隐私保护机制（mDNS）

**解决方案**：
1. **手动设置 IP**：点击"手动设置 IP"按钮，输入您的局域网 IP
2. **查看本机 IP**：
   - Windows: 打开命令提示符，运行 `ipconfig`
   - Mac/Linux: 打开终端，运行 `ifconfig` 或 `ip addr`
3. **直接扫描**：即使不知道本机 IP，也可以直接点击扫描

### 8. 跨设备连接问题

**症状**：局域网内其他设备无法连接

**解决方案**：
1. 确保设备在同一局域网内
2. 检查防火墙设置
3. 使用 IP 地址而不是 localhost
4. 通过 URL 参数指定正确的信令服务器地址：
   ```
   http://192.168.1.100:3000?server=192.168.1.100:3001
   ```

## 调试技巧

### 1. 查看控制台日志
打开浏览器开发者工具（F12），查看控制台输出：
- 连接状态变化
- 数据通道状态
- 错误详情
- 文件夹检测日志（搜索"[粘贴调试]"或"[文件夹检测]"）

### 2. 监控网络状态
在开发者工具的 Network 标签中：
- 检查 WebSocket 连接
- 查看信令交换

### 3. 测试步骤
1. 先测试小文件（< 1MB）
2. 确认连接稳定后再传输大文件
3. 一次只传输一个文件

### 4. 启用详细日志
在 `config.js` 中启用调试模式：
```javascript
config.debug = {
  enabled: true,
  logLevel: 'debug'
}
```

## 性能优化建议

### 局域网环境
```javascript
config.options = {
  chunkSize: 1 * 1024 * 1024,      // 1MB
  maxConcurrentChunks: 5,           // 5个并发
}
```

### 广域网环境
```javascript
config.options = {
  chunkSize: 256 * 1024,            // 256KB
  maxConcurrentChunks: 3,           // 3个并发
}
```

### 低速/不稳定网络
```javascript
config.options = {
  chunkSize: 64 * 1024,             // 64KB
  maxConcurrentChunks: 2,           // 2个并发
}
```

## 快速检查清单

- [ ] WebSocket 服务器正在运行
- [ ] 两个设备可以互相访问
- [ ] 使用相同的信令服务器地址
- [ ] 浏览器支持 WebRTC（Chrome/Firefox/Edge）
- [ ] 没有浏览器扩展阻止 WebRTC
- [ ] 设置了合理的块大小和并发数
- [ ] 防火墙允许相关端口
- [ ] 网络连接稳定

## 错误代码说明

| 错误代码 | 含义 | 解决方案 |
|---------|------|----------|
| `EADDRINUSE` | 端口被占用 | 更换端口或终止占用进程 |
| `ECONNREFUSED` | 连接被拒绝 | 检查服务器是否运行 |
| `NetworkError` | 网络错误 | 检查网络连接 |
| `OperationError` | 操作错误 | 通常是 WebRTC 数据通道问题 |

## 获取帮助

如果问题仍然存在：

1. **查看日志**：检查 `logs/` 目录下的日志文件
2. **创建 Issue**：在项目仓库中创建详细的问题报告
3. **提供信息**：包含错误信息、浏览器版本、操作系统等

---

**提示：** 大多数连接问题都与网络配置和防火墙设置有关，请优先检查这些设置。 