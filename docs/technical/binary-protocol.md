# P2P 文件传输二进制协议规范

## 概述
P2P文件传输系统使用二进制协议来提高传输效率，减少元数据开销。协议流程：
1. **FILE_START** - 初始化文件传输
2. **FILE_CHUNK_WITH_DATA** × N - 发送所有文件块
3. **FILE_END** - 发送传输结束信号（用于调试分析）
4. **自动完成** - 当所有块接收完成时自动结束

所有消息都以统一的头部格式开始。

## 通用头部格式
```
[2字节 messageType] [16字节 id] [变长数据]
```

## 消息类型定义

### 0x01 - FILE_CHUNK_WITH_DATA
文件块数据传输消息（含数据）
```
偏移 | 长度 | 字段名      | 说明
-----|------|-------------|--------------------
0    | 2    | messageType | 0x01
2    | 16   | id          | 文件传输ID (UUID二进制格式)
18   | 6    | chunkIndex  | 块索引 (48位整数)
24   | 6    | chunkSize   | 数据块大小 (48位整数)
30   | N    | data        | 文件数据块 (最大262,114字节)
```
总大小限制：256KB (262,144字节)

### 0x02 - FILE_START
开始文件传输消息
```
偏移 | 长度 | 字段名      | 说明
-----|------|-------------|--------------------
0    | 2    | messageType | 0x02
2    | 16   | id          | 文件传输ID (UUID二进制格式)
18   | 8    | size        | 文件总大小 (64位整数)
26   | 6    | chunkSize   | 块大小 (48位整数)
32   | 6    | totalChunks | 总块数 (48位整数)
38   | 2    | nameLength  | 文件名长度 (16位整数)
40   | N    | name        | 文件名 (UTF-8编码)
40+N | 2    | typeLength  | 文件类型长度 (16位整数)
42+N | M    | fileType    | 文件类型 (UTF-8编码)
```

### 0x03 - FILE_END
结束文件传输消息（调试用）
```
偏移 | 长度 | 字段名      | 说明
-----|------|-------------|--------------------
0    | 2    | messageType | 0x03
2    | 16   | id          | 文件传输ID (UUID二进制格式)
```
总大小：18字节

该消息用于调试分析丢包情况。接收端收到此消息后会：
- 检查是否接收到所有预期的数据块
- 如果有缺失块，打印详细的丢包分析报告
- 分析丢包模式（连续丢包 vs 随机丢包）
- 如果缺失块数量合理，自动请求重传

### 0x05 - REQUEST_RETRANSMIT
请求重传消息
```
偏移 | 长度 | 字段名          | 说明
-----|------|-----------------|--------------------
0    | 2    | messageType     | 0x05
2    | 16   | id              | 文件传输ID (UUID二进制格式)
18   | 2    | missingCount    | 缺失块数量 (16位整数)
20   | 6*N  | missingChunks   | 缺失块索引数组 (每个6字节)
```

### 0x06 - FILE_CHUNK_WITH_HASH
带CRC32校验的文件块数据（扩展版本）
```
偏移 | 长度 | 字段名          | 说明
-----|------|-----------------|--------------------
0    | 2    | messageType     | 0x06
2    | 16   | id              | 文件传输ID (UUID二进制格式)
18   | 6    | chunkIndex      | 数据块索引 (48位整数)
24   | 6    | chunkSize       | 数据块大小 (48位整数)
30   | 4    | crc32           | 数据块CRC32校验和
34   | N    | chunkData       | 实际文件数据
```

该消息与0x01的区别是增加了4字节的CRC32校验字段。接收端会：
- 重新计算接收到数据的CRC32
- 与发送端的CRC32对比
- 如果不匹配，丢弃该块并可能请求重传

## 数据类型说明

### 整数类型
- 16位整数：小端序，2字节，范围 0 ~ 65,535
- 32位整数：小端序，4字节，范围 0 ~ 4,294,967,295 
- 48位整数：小端序，6字节，范围 0 ~ 281,474,976,710,655 (281TB)
- 64位整数：小端序，8字节，范围 0 ~ 18,446,744,073,709,551,615 (18EB)

### 字段容量说明
| 字段 | 类型 | 最大值 | 实际支持 |
|------|------|--------|----------|
| chunkSize | 48位 | 281TB | 支持任意合理的块大小 |
| totalChunks | 48位 | 281万亿个 | 支持超大文件分块 |
| nameLength | 16位 | 65535字节 | 支持超长文件名/路径 |
| typeLength | 16位 | 65535字节 | 支持复杂MIME类型 |

### UUID格式
UUID字符串 (如 "550e8400-e29b-41d4-a716-446655440000") 转换为16字节二进制格式：
- 移除连字符
- 每2个十六进制字符转换为1个字节

### 字符串编码
- 使用UTF-8编码
- 前缀长度字节表示字符串字节长度（不是字符数）
- file-start消息中的字符串最大长度65535字节（2字节长度字段）
- 其他消息中的字符串最大长度255字节（1字节长度字段）

## 向后兼容性
系统保持对旧JSON格式的兼容，会先尝试解析二进制格式，失败后回退到JSON格式。

## 性能优势

### 消息大小对比
| 消息类型 | JSON格式 | 二进制格式 | 节省比例 |
|----------|----------|------------|----------|
| file-start (典型) | ~140字节 | 64字节 | 54% |
| file-end | ~70字节 | 18字节 | 74% |
| file-chunk-with-data | ~90字节 + 数据 | 30字节 + 数据 | 67% |
| request-retransmit (5块) | ~120字节 | 50字节 | 58% |

### 其他优势
- ✅ 避免了JSON解析/序列化开销
- ✅ 固定字段位置便于快速解析
- ✅ 数据类型安全（整数不会丢失精度）
- ✅ 减少网络传输量和CPU使用率
- ✅ 简化协议流程（无需结束信号）
- ✅ 自动完成检测（基于块计数）

## 使用说明

### 自动启用
二进制协议在新版本中**自动启用**，无需额外配置。系统会：
1. 优先使用二进制格式发送消息
2. 自动检测并解析二进制格式
3. 保持对旧JSON格式的向后兼容

### 故障转移
如果二进制编码失败，系统会自动回退到JSON格式，确保兼容性。

### 调试信息
在浏览器控制台中可以看到相关日志：
```
[P2P-DEBUG] 发送二进制消息 file-start，大小: 64字节
[P2P-DEBUG] 收到二进制消息: file-end，大小: 18字节
```

## 实际应用场景

### 大文件支持示例
扩展字段长度后，协议现在可以支持：

**视频文件传输** (100GB 4K电影)
- 文件大小: 100GB (在64位范围内)
- 块大小: 16MB (在48位范围内) 
- 总块数: 6,400个 (在48位范围内)
- 消息大小: 仅79字节

**企业级备份** (10TB数据库备份)
- 文件大小: 10TB (在64位范围内)
- 块大小: 256MB (在48位范围内)
- 总块数: 40,960个 (在48位范围内)  
- 支持包含完整路径的长文件名

**科学数据集** (1PB基因组数据)
- 文件大小: 1PB (在64位范围内)
- 块大小: 1GB (在48位范围内)
- 总块数: 约100万个 (在48位范围内)
- 支持复杂的MIME类型描述

这些扩展确保了协议的长期可用性和灵活性。 