# 文件传输断开测试说明

## 功能说明

当文件传输过程中发送端断开连接时，接收端会显示传输失败的信息，包括：
- 失败原因（连接已断开/数据通道已关闭）
- 已完成的传输进度百分比

## 测试步骤

### 准备工作
1. 确保 WebSocket 信令服务器正在运行
2. 打开两个浏览器窗口

### 测试流程
1. **设置用户 ID**
   - 窗口 A：设置 ID 为 "alice"
   - 窗口 B：设置 ID 为 "bob"

2. **建立连接**
   - 在窗口 A 中点击 bob 旁边的"连接"按钮
   - 或在窗口 B 中点击 alice 旁边的"连接"按钮

3. **开始传输文件**
   - 在窗口 A 中选择一个较大的文件（建议 > 10MB）
   - 文件开始传输，两端都会显示进度

4. **模拟断开连接**
   - 在文件传输到 30-50% 时，关闭窗口 A（发送端）
   - 或者刷新窗口 A 页面
   - 或者关闭窗口 A 的网络连接

5. **查看结果**
   - 窗口 B（接收端）应该显示：
     - ❌ 传输失败: 连接已断开 (已完成 XX.X%)
     - 红色的错误文字
     - 进度条和传输信息被隐藏

## 实现细节

### 连接状态监听
- 监听 `RTCPeerConnection` 的 `connectionState` 变化
- 监听 `DataChannel` 的 `close` 事件
- 当检测到 `failed`、`disconnected` 或 `closed` 状态时触发失败处理

### 失败事件处理
- 发送端：抛出错误，显示发送失败信息
- 接收端：触发 `filefailed` 事件，显示接收失败信息
- 清理未完成的传输状态

### 用户体验优化
- 显示具体的失败原因
- 显示已完成的传输进度
- 使用红色文字突出显示错误
- 隐藏不再需要的进度条和传输速度信息 