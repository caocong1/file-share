# 故障排除指南

## 常见问题

### 1. OperationError: Failure to send data

**症状**：传输过程中报错，提示发送数据失败，数据通道关闭

**原因**：
- 网络不稳定或连接质量差
- 数据块太大，超出网络承载能力
- 缓冲区溢出
- 对端设备性能不足或网络较差

**解决方案**：
1. 系统会自动重试失败的块（最多3次）
2. 使用更小的块大小（已调整为 256KB）
3. 降低并发数（已调整为 3）
4. 检查网络连接质量
5. 如果问题持续，尝试：
   - 关闭其他占用带宽的应用
   - 靠近路由器或使用有线连接
   - 重启浏览器

### 2. RTCDataChannel.readyState is not 'open'

**症状**：选择文件后立即报错，提示数据通道未打开

**原因**：
- WebRTC 连接建立是异步的
- 数据通道需要时间来完成握手
- 可能在连接完全建立前就尝试发送数据

**解决方案**：
1. 系统会自动等待最多 5 秒让数据通道打开
2. 确保先建立连接，等待连接成功提示
3. 如果问题持续，尝试重新连接

### 2. RTCDataChannel send queue is full

**症状**：传输大文件时报错，提示发送队列已满

**原因**：
- 文件块太大
- 并发传输数太高
- 网络速度跟不上发送速度

**解决方案**：
1. 减小块大小（建议 256KB - 1MB）
2. 降低并发数（建议 3-5）
3. 检查网络连接质量

### 3. 连接失败或超时

**症状**：点击连接后长时间无响应或失败

**可能原因**：
- 防火墙阻止 WebRTC 连接
- STUN 服务器不可用
- 网络配置问题

**解决方案**：
1. 确保两个设备在同一网络
2. 检查防火墙设置
3. 尝试使用公共 STUN 服务器：
   ```javascript
   stunServer: 'stun:stun.l.google.com:19302'
   ```

## 调试技巧

### 1. 查看控制台日志
打开浏览器开发者工具（F12），查看控制台输出：
- 连接状态变化
- 数据通道状态
- 错误详情

### 2. 监控网络状态
在开发者工具的 Network 标签中：
- 检查 WebSocket 连接
- 查看信令交换

### 3. 测试步骤
1. 先测试小文件（< 1MB）
2. 确认连接稳定后再传输大文件
3. 一次只传输一个文件

## 性能优化建议

### 局域网环境
```javascript
config.options = {
  chunkSize: 1 * 1024 * 1024,      // 1MB
  maxConcurrentChunks: 5,           // 5个并发
}
```

### 广域网环境
```javascript
config.options = {
  chunkSize: 256 * 1024,            // 256KB
  maxConcurrentChunks: 3,           // 3个并发
}
```

### 低速/不稳定网络
```javascript
config.options = {
  chunkSize: 64 * 1024,             // 64KB
  maxConcurrentChunks: 2,           // 2个并发
}
```

## 快速检查清单

- [ ] WebSocket 服务器正在运行
- [ ] 两个设备可以互相访问
- [ ] 使用相同的信令服务器地址
- [ ] 浏览器支持 WebRTC（Chrome/Firefox/Edge）
- [ ] 没有浏览器扩展阻止 WebRTC
- [ ] 设置了合理的块大小和并发数 