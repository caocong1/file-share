<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="安全、快速、简单的局域网文件传输工具" />
		<title>局域网文件传输</title>
		<link
			rel="icon"
			href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🚀</text></svg>"
		>
		<style>
      :root {
        --primary: #3b82f6;
        --primary-hover: #2563eb;
        --secondary: #f8fafc;
        --accent: #10b981;
        --accent-hover: #059669;
        --danger: #ef4444;
        --warning: #f59e0b;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --text-light: #9ca3af;
        --border: #e5e7eb;
        --border-light: #f3f4f6;
        --surface: #ffffff;
        --surface-elevated: #ffffff;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --radius: 8px;
        --radius-lg: 12px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        line-height: 1.6;
        color: var(--text-primary);
        padding: 1rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        animation: fadeIn 0.6s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .header {
        background: var(--surface);
        padding: 2rem;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-lg);
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header h1 {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }

      .header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1.5rem;
        align-items: start;
      }

      .panel {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .panel:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      }

      .panel h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .panel h2::before {
        content: '';
        width: 4px;
        height: 1.5rem;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 2px;
      }

      .panel h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 1.5rem 0 0.75rem 0;
        color: var(--text-primary);
      }

      .input-group {
        margin-bottom: 1.5rem;
      }

      .input-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.9rem;
      }

      .input-group input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
        transition: all 0.2s ease;
        background: var(--surface);
      }

      .input-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .button {
        width: 100%;
        padding: 0.75rem 1.5rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        margin-top: 0.75rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }

      .button:hover::before {
        left: 100%;
      }

      .button:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .button:active {
        transform: translateY(0);
      }

      .button:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .button.primary {
        background: var(--accent);
      }

      .button.primary:hover {
        background: var(--accent-hover);
      }

      .id-section {
        margin-bottom: 1.5rem;
      }

      .id-card {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        transition: all 0.3s ease;
      }

      .id-card.active-id {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05));
        border-color: var(--accent);
      }

      .id-card-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .id-icon {
        font-size: 1rem;
      }

      .id-input-wrapper, .id-display-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .id-input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) / 1.5);
        font-size: 0.9rem;
        transition: all 0.2s ease;
        background: var(--surface);
      }

      .id-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .current-id {
        flex: 1;
        font-size: 1.1rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .id-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: calc(var(--radius) / 1.5);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 60px;
        background: var(--primary);
        color: white;
      }

      .id-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      .id-btn.secondary {
        background: var(--text-light);
        color: var(--text-primary);
      }

      .id-btn.secondary:hover {
        background: var(--text-secondary);
        color: white;
      }

      .list-container {
        max-height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
        border-radius: var(--radius);
        border: 1px solid var(--border-light);
      }

      .list-container::-webkit-scrollbar {
        width: 6px;
      }

      .list-container::-webkit-scrollbar-track {
        background: var(--border-light);
        border-radius: 3px;
      }

      .list-container::-webkit-scrollbar-thumb {
        background: var(--text-light);
        border-radius: 3px;
      }

      .list-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      .device-item, .online-user-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .device-item:last-child, .online-user-item:last-child {
        border-bottom: none;
      }

      .device-item:hover, .online-user-item:hover {
        background: var(--secondary);
        transform: translateX(4px);
      }

      .device-item.selected {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
        border-left: 4px solid var(--primary);
      }

      .online-user-item.self {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
        border-left: 4px solid var(--accent);
      }

      .connect-btn-small {
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: calc(var(--radius) / 2);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 70px;
      }

      .connect-btn-small:hover {
        background: var(--primary-hover);
        transform: scale(1.05);
      }

      .connect-btn-small:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
      }

      .drop-zone {
        border: 2px dashed var(--border);
        border-radius: var(--radius-lg);
        padding: 3rem 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.8));
        cursor: pointer;
      }

      .drop-zone:hover, .drop-zone.active {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
        transform: scale(1.02);
      }

      .drop-zone-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.7;
      }

      .drop-zone p {
        margin: 0.5rem 0;
      }

      .drop-zone .primary-text {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .drop-zone .secondary-text {
        color: var(--text-secondary);
      }

      .drop-zone .paste-hint {
        color: var(--text-light);
        font-size: 0.8rem;
        margin-top: 0.5rem;
        opacity: 0.8;
        transition: all 0.3s ease;
      }

      .drop-zone .paste-hint kbd {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #adb5bd;
        border-bottom: 2px solid #6c757d;
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', monospace;
        font-size: 0.75rem;
        font-weight: 600;
        color: #495057;
        margin: 0 0.1rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        display: inline-block;
        min-width: 1.5rem;
        text-align: center;
        position: relative;
        top: -1px;
        transition: all 0.15s ease;
        user-select: none;
      }

      .drop-zone .paste-hint kbd:hover {
        background: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%);
        transform: translateY(-0.5px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }

      /* 深色模式下的 kbd 样式 */
      @media (prefers-color-scheme: dark) {
        .drop-zone .paste-hint kbd {
          background: linear-gradient(135deg, #495057 0%, #343a40 100%);
          border: 1px solid #6c757d;
          border-bottom: 2px solid #adb5bd;
          color: #f8f9fa;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .drop-zone .paste-hint kbd:hover {
          background: linear-gradient(135deg, #5a6268 0%, #3d4449 100%);
          transform: translateY(-0.5px);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
      }

      .file-list {
        max-height: 400px;
        overflow-y: auto;
        border-radius: var(--radius);
      }

      .file-item {
        background: var(--surface);
        padding: 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-light);
        transition: all 0.2s ease;
      }

      .file-item:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .file-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        flex-direction: column;
      }

      .file-name {
        font-weight: 600;
        color: var(--text-primary);
        word-break: break-word;
      }

      .file-size {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-left: 0.5rem;
      }

      .file-status {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
      }

      .file-info {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin: 0.75rem 0;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .file-progress {
        height: 6px;
        background: var(--border-light);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.75rem;
      }

      .file-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        transition: width 0.3s ease;
        border-radius: 3px;
      }

      .info-box {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: var(--text-primary);
        padding: 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
      }

      .info-box strong {
        color: var(--warning);
      }

      .info-box ol {
        margin-top: 0.75rem;
        margin-left: 1.5rem;
      }

      .info-box li {
        margin: 0.25rem 0;
      }

      .empty-state {
        text-align: center;
        color: var(--text-light);
        padding: 2rem;
        font-style: italic;
      }

      .notification {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        color: white;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .notification.success {
        background: var(--accent);
      }

      .notification.error {
        background: var(--danger);
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }

      .status-indicator.online {
        background: var(--accent);
      }

      .status-indicator.offline {
        background: var(--text-light);
      }

      /* 触摸设备优化 */
      @media (hover: none) and (pointer: coarse) {
        .button, .connect-btn-small {
          min-height: 44px; /* iOS 推荐的最小触摸目标 */
        }
        
        .device-item, .online-user-item {
          min-height: 44px;
        }
      }

      /* 响应式设计 */
      @media (max-width: 768px) {
        body {
          padding: 0.5rem;
        }

        .main-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .header {
          padding: 1.5rem;
          margin-bottom: 1rem;
        }

        .panel {
          padding: 1rem;
        }

        .id-card {
          padding: 0.75rem;
        }

        .id-input-wrapper, .id-display-wrapper {
          flex-direction: column;
          gap: 0.5rem;
          align-items: stretch;
        }

        .id-btn {
          align-self: stretch;
        }

        .drop-zone {
          padding: 2rem 1rem;
        }

        .drop-zone-icon {
          font-size: 2rem;
        }

        .file-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .file-info {
          flex-direction: column;
          gap: 0.25rem;
        }

        .device-item, .online-user-item {
          padding: 0.75rem;
        }

        .notification {
          top: 0.5rem;
          right: 0.5rem;
          left: 0.5rem;
          margin: 0;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.5rem;
        }

        .panel h2 {
          font-size: 1.25rem;
        }

        .button {
          padding: 0.875rem 1.5rem;
        }

        .drop-zone {
          padding: 1.5rem 1rem;
        }

        .file-item {
          padding: 1rem;
        }
      }

      /* 深色模式支持 */
      @media (prefers-color-scheme: dark) {
        :root {
          --surface: #1f2937;
          --surface-elevated: #374151;
          --text-primary: #f9fafb;
          --text-secondary: #d1d5db;
          --text-light: #9ca3af;
          --border: #374151;
          --border-light: #4b5563;
          --secondary: #374151;
        }

        body {
          background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        .panel, .header {
          background: rgba(31, 41, 55, 0.8);
          border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .file-item {
          background: var(--surface-elevated);
        }

        .drop-zone {
          background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(55, 65, 81, 0.8));
        }

        .id-card {
          background: rgba(55, 65, 81, 0.5);
          border-color: var(--border);
        }

        .id-card.active-id {
          background: rgba(16, 185, 129, 0.15);
          border-color: var(--accent);
        }

        .id-input {
          background: var(--surface-elevated);
          border-color: var(--border);
          color: var(--text-primary);
        }
      }
    </style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>🚀 局域网文件传输</h1>
				<p>安全、快速、简单的点对点文件传输工具</p>
			</div>

			<div class="main-grid">
				<div class="panel">
					<h2>🔗 连接设置</h2>

					<div class="info-box">
						<strong>💡 使用说明：</strong>
						<ol>
							<li>设置您的 ID（ID 只能包含字母、数字、下划线和横线）</li>
							<li>在"在线用户"列表中点击连接按钮</li>
							<li>连接成功后即可传输文件</li>
						</ol>
					</div>

					<!-- ID 管理区域 -->
					<div class="id-section">
						<div id="idSetupCard" class="id-card">
							<!-- <div class="id-card-header">
                <span class="id-icon">👤</span>
                <span>设置您的身份ID</span>
              </div> -->
							<div class="id-input-wrapper">
								<input
									type="text"
									id="myIdInput"
									placeholder="输入您的 ID (如: alice)"
									maxlength="20"
									class="id-input"
								>
								<button id="setIdBtn" class="id-btn">设置</button>
							</div>
						</div>

						<div
							id="idDisplayCard"
							class="id-card active-id"
							style="display: none"
						>
							<!-- <div class="id-card-header">
                <span class="id-icon">✅</span>
                <span>当前身份</span>
              </div> -->
							<div class="id-display-wrapper">
								<div class="current-id" id="myIdText"></div>
								<button id="changeIdBtn" class="id-btn secondary">修改</button>
							</div>
						</div>
					</div>

					<!-- 在线用户列表 -->
					<h3>👥 在线用户</h3>
					<div class="list-container">
						<div id="onlineUsersList">
							<div class="empty-state">正在获取在线用户...</div>
						</div>
					</div>

					<!-- 已连接的用户列表 -->
					<h3>✅ 已连接的用户</h3>
					<div class="list-container">
						<div id="deviceList">
							<div class="empty-state">尚未连接任何用户</div>
						</div>
					</div>
				</div>

				<div class="panel">
					<h2>📁 文件传输</h2>

					<div id="dropZone" class="drop-zone">
						<div class="drop-zone-icon">📤</div>
						<p class="primary-text">拖拽文件到这里</p>
						<p class="secondary-text">或点击选择文件</p>
						<p class="paste-hint" id="pasteHint">也可以按 Ctrl+V 粘贴文件</p>
						<input type="file" id="fileInput" multiple style="display: none" />
					</div>

					<h3>📋 传输列表</h3>
					<div class="file-list" id="fileList">
						<div class="empty-state">暂无文件传输</div>
					</div>
				</div>
			</div>
		</div>

		<script type="module">
      import { P2PManagerWS } from './p2p-manager-ws.js'
      import { config, updateConfigFromURL } from './config.js'

      // 更新配置（从 URL 参数）
      updateConfigFromURL()

      const manager = new P2PManagerWS()
      let selectedDevice = null
      const devices = new Map()
      const onlineUsers = new Set()

      // DOM 元素
      const myIdInput = document.getElementById('myIdInput')
      const setIdBtn = document.getElementById('setIdBtn')
      const changeIdBtn = document.getElementById('changeIdBtn')
      const idSetupCard = document.getElementById('idSetupCard')
      const idDisplayCard = document.getElementById('idDisplayCard')
      const myIdText = document.getElementById('myIdText')
      const deviceList = document.getElementById('deviceList')
      const onlineUsersList = document.getElementById('onlineUsersList')
      const dropZone = document.getElementById('dropZone')
      const fileInput = document.getElementById('fileInput')
      const fileList = document.getElementById('fileList')

      // 系统检测工具函数
      function detectOS() {
        const userAgent = navigator.userAgent.toLowerCase()
        return {
          isMac: userAgent.includes('mac') || userAgent.includes('darwin'),
          isIOS: /ipad|iphone|ipod/.test(userAgent),
          isWindows: userAgent.includes('win'),
          isLinux: userAgent.includes('linux') && !userAgent.includes('android'),
          isAndroid: userAgent.includes('android')
        }
      }

      // 检测操作系统并更新快捷键提示
      function updatePasteHint() {
        const pasteHint = document.getElementById('pasteHint')
        if (!pasteHint) return
        
        const os = detectOS()
        
        let description = '粘贴文件'
        
        if (os.isMac && !os.isIOS) {
          pasteHint.innerHTML = `也可以按 <kbd>⌘</kbd>+<kbd>V</kbd> ${description}`
        } else if (os.isIOS) {
          // iOS设备不支持文件粘贴，提示不同内容
          pasteHint.innerHTML = '或从 <strong>照片</strong> 应用长按粘贴图片'
          pasteHint.style.opacity = '0.7'
          pasteHint.style.fontSize = '0.75rem'
        } else if (os.isAndroid) {
          // Android设备的粘贴功能有限
          pasteHint.innerHTML = '或使用 <strong>分享</strong> 功能传输文件'
          pasteHint.style.opacity = '0.7'
          pasteHint.style.fontSize = '0.75rem'
        } else {
          // Windows/Linux
          pasteHint.innerHTML = `也可以按 <kbd>Ctrl</kbd>+<kbd>V</kbd> ${description}`
        }
      }

      // 初始化
      async function init() {
        // 使用配置文件中的信令服务器地址
        const success = await manager.init(config.signalServer)

        if (!success) {
          const error = document.createElement('div')
          error.className = 'notification error'
          error.style.position = 'relative'
          error.style.top = 'auto'
          error.style.right = 'auto'
          error.style.marginBottom = '1rem'
          error.innerHTML = `<strong>❌ 错误：</strong>无法连接到信令服务器<br>
            请确保：<br>
            1. 运行了 WebSocket 信令服务器：<code>node ws-signal-server.js</code><br>
            2. 在 config.js 中配置了正确的服务器地址<br>
            3. 或使用 URL 参数：<code>?server=[IP]:3001</code>`
          document.querySelector('.header').appendChild(error)
          return
        }

        if (config.signalServer) {
          // 显示连接信息
          // const info = document.createElement('div')
          // info.style.cssText =
          //   'background: #e3f2fd; padding: 10px; margin-bottom: 10px; border-radius: 5px;'
          // info.innerHTML = `<strong>已连接到信令服务器</strong>：${config.signalServer}<br>
          //   其他设备请访问相同的地址或配置相同的服务器`
          // document.querySelector('.header').appendChild(info)
          console.log('已连接到信令服务器', config.signalServer)
        }

        // 更新快捷键提示
        updatePasteHint()
        
        // 输出系统检测信息（用于调试）
        const os = detectOS()
        console.log('🔍 系统检测结果:', {
          系统类型: os.isMac ? 'macOS' : os.isWindows ? 'Windows' : os.isLinux ? 'Linux' : os.isAndroid ? 'Android' : os.isIOS ? 'iOS' : '未知',
          快捷键: os.isMac && !os.isIOS ? '⌘+V' : 'Ctrl+V',
          HTML结构: os.isMac && !os.isIOS ? '<kbd>⌘</kbd>+<kbd>V</kbd>' : '<kbd>Ctrl</kbd>+<kbd>V</kbd>',
          支持粘贴: !(os.isIOS || os.isAndroid),
          用户代理: navigator.userAgent
        })

        // 检查是否已有保存的 ID
        const savedId = localStorage.getItem('myP2PId')
        if (savedId) {
          myIdInput.value = savedId
          setMyId()
        }
      }

      // 设置我的 ID
      setIdBtn.onclick = setMyId
      changeIdBtn.onclick = () => {
        idDisplayCard.style.display = 'none'
        idSetupCard.style.display = 'block'
        myIdInput.focus()
      }

      // 回车键设置ID
      myIdInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          setMyId()
        }
      })

      async function setMyId() {
        const myId = myIdInput.value.trim().toLowerCase()
        if (!myId) {
          alert('请输入一个有效的 ID')
          return
        }

        if (!/^[a-z0-9_-]+$/i.test(myId)) {
          alert('ID 只能包含字母、数字、下划线和横线')
          return
        }

        // 设置加载状态
        setIdBtn.disabled = true
        const originalText = setIdBtn.textContent
        setIdBtn.textContent = '设置中...'

        try {
          // 如果是修改ID，先断开所有连接
          const isChangingId = manager.myId && manager.myId !== myId
          if (isChangingId) {
          const oldId = manager.myId
          console.log(`正在修改ID: ${oldId} -> ${myId}`)
          
          // 立即清理前端状态
          devices.clear()
          deviceList.innerHTML = '<div class="empty-state">尚未连接任何用户</div>'
          selectedDevice = null
          
          // 从在线用户列表中移除旧ID（如果存在）
          onlineUsers.delete(oldId)
          
          // 断开所有连接
          manager.disconnectAll()
          
          // 先注销旧ID并等待确认
          try {
            await manager.unregisterUser()
            console.log('旧ID注销成功')
          } catch (error) {
            console.warn('注销旧ID失败，继续执行:', error.message)
          }
          
          // 注销完成后立即进行后续操作
          // 重新连接WebSocket以确保服务器状态清理（跳过自动注册旧ID）
          await manager.reconnectWebSocket(true)
          
          // 设置新ID
          manager.setMyId(myId)
          localStorage.setItem('myP2PId', myId)
          
          console.log(`ID已更新为: ${myId}`)
          
          // 更新界面显示
          myIdText.textContent = myId
          idSetupCard.style.display = 'none'
          idDisplayCard.style.display = 'block'
          
          // 显示成功通知
          const notification = document.createElement('div')
          notification.className = 'notification success'
          notification.innerHTML = `✅ ID 已更新为 ${myId}，所有连接已断开`
          document.body.appendChild(notification)
          
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification)
            }
          }, 3000)
          
          // 服务器会在用户上线时自动推送在线用户列表，无需主动获取
          
          return // 提前返回，避免重复设置
        }

        manager.setMyId(myId)
        localStorage.setItem('myP2PId', myId)

                  myIdText.textContent = myId
          idSetupCard.style.display = 'none'
          idDisplayCard.style.display = 'block'

          // 服务器会在用户注册成功后自动推送在线用户列表，无需主动获取
        } catch (error) {
          console.error('设置ID失败:', error)
          alert('设置ID失败: ' + error.message)
        } finally {
          // 恢复按钮状态
          setIdBtn.disabled = false
          setIdBtn.textContent = originalText
        }
      }

      // 更新在线用户列表显示
      function updateOnlineUsersList() {
        if (onlineUsers.size === 0 && !manager.myId) {
          onlineUsersList.innerHTML = '<div class="empty-state">请先设置您的 ID</div>'
          return
        }

        if (onlineUsers.size === 0) {
          onlineUsersList.innerHTML = '<div class="empty-state">暂无其他在线用户</div>'
          return
        }

        onlineUsersList.innerHTML = ''
        for (const userId of onlineUsers) {
          const userDiv = document.createElement('div')
          userDiv.className = 'online-user-item'
          
          const isConnected = devices.has(userId)
          
          userDiv.innerHTML = `
            <span>
              <span class="status-indicator ${isConnected ? 'online' : 'offline'}"></span>
              <strong>${userId}</strong>${isConnected ? ' (已连接)' : ''}
            </span>
            <button class="connect-btn-small" ${isConnected ? 'disabled' : ''} 
                    onclick="connectToUser('${userId}')">
              ${isConnected ? '已连接' : '连接'}
            </button>
          `
          onlineUsersList.appendChild(userDiv)
        }
      }

      // 连接到指定用户
      window.connectToUser = async (userId) => {
        if (!manager.myId) {
          alert('请先设置您自己的 ID')
          return
        }

        if (userId === manager.myId) {
          alert('不能连接到自己')
          return
        }

        // 禁用所有连接按钮
        const connectButtons = onlineUsersList.querySelectorAll('.connect-btn-small')
        connectButtons.forEach(btn => btn.disabled = true)

        try {
          await manager.connectToPeer(userId)

          // 添加到设备列表
          const device = { id: userId, name: userId }
          if (!devices.has(userId)) {
            devices.set(userId, device)
            addDeviceToList(device)
          }

          updateOnlineUsersList() // 更新在线用户列表状态
        } catch (error) {
          console.error('连接失败:', error)
          alert(`连接到 ${userId} 失败: ${error.message}`)
        } finally {
          updateOnlineUsersList() // 重新启用按钮
        }
      }

      // 添加设备到列表
      function addDeviceToList(device) {
        if (deviceList.children[0]?.classList.contains('empty-state')) {
          deviceList.innerHTML = ''
        }

        const div = document.createElement('div')
        div.className = 'device-item'
        div.innerHTML = `
          <span>
            <span class="status-indicator online"></span>
            <strong>${device.name}</strong>
          </span>
        `
        div.onclick = () => selectDevice(device, div)
        deviceList.appendChild(div)

        // 自动选中
        div.click()
      }

      // 选择设备
      function selectDevice(device, element) {
        deviceList.querySelectorAll('.device-item').forEach((item) => {
          item.classList.remove('selected')
        })

        element.classList.add('selected')
        selectedDevice = device
      }

      // 文件传输相关代码...
      dropZone.onclick = () => fileInput.click()

      dropZone.ondragover = (e) => {
        e.preventDefault()
        dropZone.classList.add('active')
      }

      dropZone.ondragleave = () => {
        dropZone.classList.remove('active')
      }

      dropZone.ondrop = (e) => {
        e.preventDefault()
        dropZone.classList.remove('active')
        
        // 检查是否支持文件夹拖拽
        const items = e.dataTransfer.items
        if (items) {
          console.log('[拖拽调试] DataTransferItems数量:', items.length)
          
          // 检查是否有文件夹
          let hasFolder = false
          for (let i = 0; i < items.length; i++) {
            const item = items[i]
            if (item.kind === 'file') {
              const entry = item.webkitGetAsEntry?.() || item.getAsEntry?.()
              if (entry && entry.isDirectory) {
                hasFolder = true
                console.log('[拖拽调试] 检测到文件夹:', entry.name)
              }
            }
          }
          
          if (hasFolder) {
            alert('检测到文件夹！\n\n由于浏览器安全限制，暂时无法处理文件夹传输。\n请选择文件夹内的具体文件进行传输。')
            return
          }
        }
        
        handleFiles(e.dataTransfer.files)
      }

      fileInput.onchange = (e) => {
        handleFiles(e.target.files)
      }

      // 检测是否为文件夹的辅助函数
      function isLikelyFolder(file) {
        const os = detectOS()
        
        // 检测文件夹的特征
        const hasNoExtension = !file.name.includes('.')
        const hasZeroSize = file.size === 0
        const hasNoType = !file.type || file.type === ''
        const hasDirectoryPath = file.name.endsWith('/') || file.name.endsWith('\\')
        const hasDirectoryType = file.type === 'application/x-directory'
        
        // Mac系统特殊处理：文件夹通常有小的非零大小（元数据大小）
        const isMacSmallSize = os.isMac && file.size > 0 && file.size < 4096 // 通常小于4KB
        
        // Mac文件夹的典型特征：
        // 1. 大小通常是 68, 96, 102, 204, 238, 272, 306, 340, 374, 408等（Finder信息大小）
        // 2. 常见的文件夹大小范围
        const isMacTypicalFolderSize = os.isMac && file.size > 0 && (
          file.size === 68 || file.size === 96 || file.size === 102 || 
          file.size === 204 || file.size === 238 || file.size === 272 || 
          file.size === 306 || file.size === 340 || file.size === 374 || 
          file.size === 408 || (file.size > 60 && file.size < 500 && file.size % 34 === 0)
        )
        
        // 常见的无扩展名文件，不应被误判为文件夹
        const commonNoExtFiles = [
          'README', 'LICENSE', 'CHANGELOG', 'Dockerfile', 'Makefile', 
          '.gitignore', '.env', '.eslintrc', '.prettierrc', 'COPYING',
          'AUTHORS', 'CONTRIBUTORS', 'INSTALL', 'NEWS', 'TODO'
        ]
        const isCommonFile = commonNoExtFiles.some(name => 
          file.name.toUpperCase() === name.toUpperCase() || 
          (file.name.startsWith('.') && file.name.length > 1)
        )
        
        // 检查是否为可执行文件或脚本（这些通常没有扩展名但是文件）
        const isLikelyExecutable = file.size > 4096 && hasNoExtension && hasNoType
        
        // Mac系统的最终文件夹判断
        const isMacFolder = os.isMac && hasNoExtension && hasNoType && (isMacSmallSize || isMacTypicalFolderSize)
        
        // 最终的文件夹判断
        const isFolderResult = !isCommonFile && !isLikelyExecutable && (
          hasDirectoryType || 
          hasDirectoryPath ||
          (hasNoExtension && hasZeroSize && hasNoType) ||
          isMacFolder
        )
        
        console.log(`[文件夹检测] ${file.name}:`, {
          基本信息: {
            hasNoExtension,
            hasZeroSize,
            hasNoType,
            fileSize: file.size,
            系统: os.isMac ? 'Mac' : 'Other'
          },
          特征检测: {
            hasDirectoryPath,
            hasDirectoryType,
            isMacSmallSize,
            isMacTypicalFolderSize,
            isMacFolder
          },
          排除条件: {
            isCommonFile,
            isLikelyExecutable
          },
          最终判断: isFolderResult
        })
        
        // 如果检测为Mac文件夹，给出额外提示
        if (os.isMac && isMacFolder) {
          console.log(`[Mac文件夹] 检测到Mac系统文件夹: ${file.name} (${file.size}字节)`)
        }
        
        return isFolderResult
      }

      // 显示文件夹粘贴警告
      function showFolderPasteWarning(folderNames) {
        const notification = document.createElement('div')
        notification.className = 'notification error'
        notification.innerHTML = `
          <strong>⚠️ 不支持粘贴文件夹</strong><br>
          检测到文件夹: ${folderNames.join(', ')}<br>
          <small>💡 建议：请直接拖拽文件夹到传输区域，或选择文件夹内的文件</small>
        `
        document.body.appendChild(notification)
        
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification)
          }
        }, 5000) // 显示5秒
      }

      // 粘贴文件支持
      document.addEventListener('paste', (e) => {
        e.preventDefault()
        
        const clipboardData = e.clipboardData || window.clipboardData
        if (!clipboardData) return
        
        const items = clipboardData.items
        const files = []
        const folders = []
        
        console.log('[粘贴调试] 剪贴板项目数量:', items.length)
        
        // 遍历剪贴板项目
        for (let i = 0; i < items.length; i++) {
          const item = items[i]
          
          console.log(`[粘贴调试] 项目${i}:`, {
            kind: item.kind,
            type: item.type,
            toString: item.toString?.()
          })
          
          // 检查是否是文件
          if (item.kind === 'file') {
            const file = item.getAsFile()
            if (file) {
              console.log(`[粘贴调试] 获取到文件:`, {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified,
                isLikelyFolder: isLikelyFolder(file)
              })
              
              // 检测是否为文件夹
              if (isLikelyFolder(file)) {
                folders.push(file.name)
                console.log(`[粘贴调试] 检测到疑似文件夹: ${file.name}`)
              } else {
                files.push(file)
              }
            }
          }
        }
        
        // 处理检测到的文件夹
        if (folders.length > 0) {
          console.log(`[粘贴调试] 发现 ${folders.length} 个文件夹:`, folders)
          showFolderPasteWarning(folders)
          
          // 如果同时有文件，询问用户是否继续处理文件
          if (files.length > 0) {
            const proceed = confirm(`检测到 ${folders.length} 个文件夹和 ${files.length} 个文件。\n\n文件夹无法通过粘贴传输，是否继续传输其中的文件？`)
            if (!proceed) {
              return
            }
          } else {
            // 只有文件夹，没有文件
            return
          }
        }
        
        if (files.length > 0) {
          console.log(`[粘贴调试] 准备处理 ${files.length} 个文件:`, files.map(f => ({
            name: f.name,
            size: f.size,
            type: f.type
          })))
          
          // 显示粘贴提示动画
          dropZone.classList.add('active')
          setTimeout(() => {
            dropZone.classList.remove('active')
          }, 200)
          
          handleFiles(files)
        } else {
          // 检查是否有其他文件格式（如Windows复制的文件）
          const filesList = clipboardData.files
          if (filesList && filesList.length > 0) {
            console.log(`[粘贴调试] 从clipboardData.files检测到文件:`, Array.from(filesList).map(f => ({
              name: f.name,
              size: f.size,
              type: f.type,
              isLikelyFolder: isLikelyFolder(f)
            })))
            
            // 对clipboardData.files也进行文件夹检测
            const validFiles = []
            const detectedFolders = []
            
            for (const file of filesList) {
              if (isLikelyFolder(file)) {
                detectedFolders.push(file.name)
              } else {
                validFiles.push(file)
              }
            }
            
            if (detectedFolders.length > 0) {
              showFolderPasteWarning(detectedFolders)
            }
            
            if (validFiles.length > 0) {
              handleFiles(validFiles)
            }
          } else {
            console.log('[粘贴调试] 剪贴板中没有检测到任何文件')
          }
        }
      })

      // 显示粘贴键盘快捷键提示
      document.addEventListener('keydown', (e) => {
        const os = detectOS()
        
        // 检测正确的快捷键组合
        const isCorrectShortcut = os.isMac && !os.isIOS ? 
          (e.metaKey && e.key === 'v') : // Mac: Cmd+V
          (e.ctrlKey && e.key === 'v')   // Windows/Linux: Ctrl+V
        
        if (isCorrectShortcut) {
          // 高亮显示粘贴提示
          const pasteHint = document.querySelector('.paste-hint')
          const kbdElements = pasteHint?.querySelectorAll('kbd')
          
          if (pasteHint && kbdElements && kbdElements.length > 0) {
            // 高亮整个提示文字
            pasteHint.style.color = 'var(--primary)'
            pasteHint.style.opacity = '1'
            pasteHint.style.fontWeight = '600'
            
            // 所有键盘按键按下效果
            kbdElements.forEach(kbd => {
              kbd.style.transform = 'translateY(1px)'
              kbd.style.boxShadow = '0 0 4px rgba(66, 165, 245, 0.4)'
              kbd.style.borderBottomWidth = '1px'
            })
            
            setTimeout(() => {
              pasteHint.style.color = ''
              pasteHint.style.opacity = ''
              pasteHint.style.fontWeight = ''
              
              // 恢复所有键盘按键样式
              kbdElements.forEach(kbd => {
                kbd.style.transform = ''
                kbd.style.boxShadow = ''
                kbd.style.borderBottomWidth = ''
              })
            }, 1000)
          }
        }
      })

      async function handleFiles(files) {
        if (!selectedDevice) {
          alert('请先选择一个用户')
          return
        }

        for (const file of files) {
          await sendFile(file)
        }
      }

      async function sendFile(file) {
        const fileItem = createFileItem(file)
        fileItem.dataset.fileSize = file.size // 存储文件大小
        if (fileList.children[0]?.classList.contains('empty-state')) {
          fileList.innerHTML = ''
        }
        fileList.appendChild(fileItem)

        try {
          const startTime = Date.now()
          await manager.sendFile(selectedDevice.id, file, (progressData) => {
            updateFileProgress(fileItem, progressData.progress, progressData.completedChunks, progressData.totalChunks)
          })

          const elapsed = (Date.now() - startTime) / 1000
          fileItem.querySelector('.file-status').textContent = `✅ 发送完成 (耗时: ${elapsed.toFixed(1)}秒)`
          fileItem.querySelector('.file-info').style.display = 'none'
        } catch (error) {
          console.error('发送失败:', error)
          const errorMsg = error.message || '未知错误'
          const currentProgress = fileItem.querySelector('.file-progress-bar').style.width
          fileItem.querySelector('.file-status').innerHTML = 
            `❌ 发送失败: ${errorMsg} (已完成 ${currentProgress})`
          fileItem.querySelector('.file-status').style.color = 'var(--danger)'
          fileItem.querySelector('.file-info').style.display = 'none'
          fileItem.querySelector('.file-progress').style.display = 'none'
        }
      }

      function createFileItem(file) {
        const div = document.createElement('div')
        div.className = 'file-item'
        div.innerHTML = `
          <div class="file-header">
            <div>
              <div class="file-name">📄 ${file.name}</div>
              <span class="file-size">(${formatSize(file.size)})</span>
            </div>
            <span class="file-status">⏳ 发送中...</span>
          </div>
          <div class="file-info">
            <span class="transfer-speed"></span>
            <span class="transfer-time"></span>
          </div>
          <div class="file-progress">
            <div class="file-progress-bar" style="width: 0%"></div>
          </div>
        `
        div.startTime = Date.now()
        div.lastUpdate = Date.now()
        div.lastBytes = 0
        return div
      }

      function createReceivingFileItem(metadata, fromId) {
        const div = document.createElement('div')
        div.className = 'file-item'
        div.innerHTML = `
          <div class="file-header">
            <div>
              <div class="file-name">📥 ${metadata.name}</div>
              <span class="file-size">(${formatSize(metadata.size)})</span>
            </div>
            <span class="file-status">⬇️ 从 ${fromId} 接收中...</span>
          </div>
          <div class="file-info">
            <span class="transfer-speed"></span>
            <span class="transfer-time"></span>
          </div>
          <div class="file-progress">
            <div class="file-progress-bar" style="width: 0%"></div>
          </div>
        `
        return div
      }

      function updateFileProgress(fileItem, progress, completedChunks, totalChunks) {
        const progressBar = fileItem.querySelector('.file-progress-bar')
        if (progressBar) {
          progressBar.style.width = `${progress * 100}%`
        }

        // 计算传输速度和时间
        const now = Date.now()
        const elapsed = (now - fileItem.startTime) / 1000
        const currentBytes = progress * parseInt(fileItem.dataset.fileSize || 0)
        
        if (now - fileItem.lastUpdate > 500) { // 每500ms更新一次速度
          const bytesPerSecond = (currentBytes - fileItem.lastBytes) / ((now - fileItem.lastUpdate) / 1000)
          const speed = formatSize(bytesPerSecond) + '/s'
          
          let statusText = `速度: ${speed} | 已用时: ${elapsed.toFixed(1)}秒`
          // if (completedChunks !== undefined && totalChunks !== undefined) {
          //   statusText += ` | 块: ${completedChunks}/${totalChunks}`
          // }
          
          fileItem.querySelector('.transfer-speed').textContent = statusText
          fileItem.querySelector('.transfer-time').textContent = ''
          
          fileItem.lastUpdate = now
          fileItem.lastBytes = currentBytes
        }
      }

      function updateReceivingFileProgress(fileInfo, progress, receivedChunks, totalChunks) {
        const fileItem = fileInfo.item
        const progressBar = fileItem.querySelector('.file-progress-bar')
        if (progressBar) {
          progressBar.style.width = `${progress * 100}%`
        }

        // 计算传输速度和时间
        const now = Date.now()
        const elapsed = (now - fileInfo.startTime) / 1000
        const currentBytes = progress * fileInfo.metadata.size
        
        if (!fileInfo.lastUpdate || now - fileInfo.lastUpdate > 500) { // 每500ms更新一次速度
          const bytesPerSecond = fileInfo.lastUpdate ? 
            (currentBytes - (fileInfo.lastBytes || 0)) / ((now - fileInfo.lastUpdate) / 1000) : 0
          const speed = formatSize(bytesPerSecond) + '/s'
          
          // 估计剩余时间
          const remainingBytes = fileInfo.metadata.size - currentBytes
          const eta = bytesPerSecond > 0 ? remainingBytes / bytesPerSecond : 0
          
          let statusText = `速度: ${speed} | 已用时: ${elapsed.toFixed(1)}秒`
          if (eta > 0) {
            statusText += ` | 剩余: ${eta.toFixed(1)}秒`
          }
          // if (receivedChunks !== undefined && totalChunks !== undefined) {
          //   statusText += ` | 块: ${receivedChunks}/${totalChunks}`
          // }
          
          fileItem.querySelector('.transfer-speed').textContent = statusText
          fileItem.querySelector('.transfer-time').textContent = ''
          
          fileInfo.lastUpdate = now
          fileInfo.lastBytes = currentBytes
        }
      }

      function formatSize(bytes) {
        const sizes = ['B', 'KB', 'MB', 'GB']
        if (bytes === 0) return '0 B'
        const i = Math.floor(Math.log(bytes) / Math.log(1024))
        return (
          Math.round((bytes / Math.pow(1024, i)) * 100) / 100 + ' ' + sizes[i]
        )
      }

      // 监听文件接收进度
      const receivingFiles = new Map() // 存储接收中的文件信息

      // 监听文件开始接收
      manager.onFileStart = (metadata, fromId) => {
        const fileItem = createReceivingFileItem(metadata, fromId)
        
        if (fileList.children[0]?.classList.contains('empty-state')) {
          fileList.innerHTML = ''
        }
        fileList.appendChild(fileItem)

        // 记录接收信息
        receivingFiles.set(metadata.id, {
          item: fileItem,
          startTime: Date.now(),
          metadata: metadata,
          fromId: fromId
        })
      }

      // 监听文件接收进度
      manager.onFileProgress = (data) => {
        const fileInfo = receivingFiles.get(data.id)
        if (fileInfo) {
          updateReceivingFileProgress(fileInfo, data.progress, data.receivedChunks, data.totalChunks)
        }
      }

      // 监听文件接收完成
      manager.onFileReceived = (file, fromId) => {
        // 查找对应的接收项
        let fileInfo = null
        for (const [id, info] of receivingFiles) {
          if (info.metadata.name === file.name && info.fromId === fromId) {
            fileInfo = info
            receivingFiles.delete(id)
            break
          }
        }

        if (fileInfo) {
          // 更新为完成状态
          const elapsed = (Date.now() - fileInfo.startTime) / 1000
          fileInfo.item.querySelector('.file-status').innerHTML = 
            `✅ 接收完成 (耗时: ${elapsed.toFixed(1)}秒)`
          fileInfo.item.querySelector('.file-progress').style.display = 'none'
        }
      }

      // 监听文件传输失败
      manager.onFileFailed = (failedInfo, fromId) => {
        console.log('[UI-DEBUG] 文件传输失败:', {
          fileId: failedInfo.id,
          fileName: failedInfo.name,
          reason: failedInfo.reason,
          progress: failedInfo.progress,
          fromId: fromId,
          hasFileInfo: receivingFiles.has(failedInfo.id),
          timestamp: new Date().toISOString()
        })
        
        const fileInfo = receivingFiles.get(failedInfo.id)
        if (fileInfo) {
          receivingFiles.delete(failedInfo.id)
          
          // 更新为失败状态
          const progressPercent = (failedInfo.progress * 100).toFixed(1)
          fileInfo.item.querySelector('.file-status').innerHTML = 
            `❌ 传输失败: ${failedInfo.reason} (已完成 ${progressPercent}%)`
          fileInfo.item.querySelector('.file-status').style.color = 'var(--danger)'
          fileInfo.item.querySelector('.file-progress').style.display = 'none'
          fileInfo.item.querySelector('.file-info').style.display = 'none'
        }
      }

      // 监听新连接
      manager.onPeerConnected = (peerId) => {
        console.log('[UI-DEBUG] P2P连接建立成功:', {
          peerId: peerId,
          alreadyInDevices: devices.has(peerId),
          currentDevices: Array.from(devices.keys()),
          timestamp: new Date().toISOString()
        })
        
        const device = { id: peerId, name: peerId }
        if (!devices.has(peerId)) {
          devices.set(peerId, device)
          addDeviceToList(device)
        }
        updateOnlineUsersList() // 更新在线用户列表
      }

      // 监听在线用户列表
      manager.onUsersListReceived = (users) => {
        console.log('[UI-DEBUG] 收到在线用户列表:', {
          receivedUsers: users,
          previousOnlineUsers: Array.from(onlineUsers),
          timestamp: new Date().toISOString()
        })
        
        onlineUsers.clear()
        users.forEach(userId => onlineUsers.add(userId))
        
        console.log('[UI-DEBUG] 更新后的在线用户:', Array.from(onlineUsers))
        updateOnlineUsersList()
      }

      // 监听新用户上线
      manager.onUserOnline = (userId) => {
        if (userId !== manager.myId) {
          onlineUsers.add(userId)
          updateOnlineUsersList()
        }
      }

      // 监听用户离线
      manager.onUserOffline = (userId) => {
        console.log(`[UI-DEBUG] 收到用户离线事件:`, {
          userId: userId,
          wasOnline: onlineUsers.has(userId),
          wasConnected: devices.has(userId),
          currentOnlineUsers: Array.from(onlineUsers),
          currentConnectedDevices: Array.from(devices.keys()),
          timestamp: new Date().toISOString()
        })
        
        onlineUsers.delete(userId)
        
        // 如果该用户已连接，从设备列表中移除
        if (devices.has(userId)) {
          console.log(`[UI-DEBUG] 用户 ${userId} 已连接，从设备列表中移除`)
          devices.delete(userId)
          // 更新已连接设备列表
          updateDeviceList()
        }
        
        updateOnlineUsersList()
        console.log('[UI-DEBUG] 用户离线处理完成，当前状态:', {
          onlineUsers: Array.from(onlineUsers),
          connectedDevices: Array.from(devices.keys())
        })
      }

      // 更新已连接设备列表
      function updateDeviceList() {
        if (devices.size === 0) {
          deviceList.innerHTML = '<div class="empty-state">尚未连接任何用户</div>'
          selectedDevice = null
        } else {
          deviceList.innerHTML = ''
          let firstDevice = null
          for (const [id, device] of devices) {
            const div = document.createElement('div')
            div.className = 'device-item'
            div.innerHTML = `
              <span>
                <span class="status-indicator online"></span>
                <strong>${device.name}</strong>
              </span>
            `
            div.onclick = () => selectDevice(device, div)
            deviceList.appendChild(div)
            
            if (!firstDevice) {
              firstDevice = { device, element: div }
            }
          }
          
          // 如果当前选中的设备已离线，选择第一个设备
          if (selectedDevice && !devices.has(selectedDevice.id) && firstDevice) {
            firstDevice.element.click()
          }
        }
      }

      // 定期刷新在线用户列表


      // 页面卸载时清理
      window.addEventListener('beforeunload', () => {
        manager.cleanup()
      })

      // 启动
      init()
    </script>
	</body>
</html>
