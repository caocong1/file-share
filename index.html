<!doctype html>
<html lang="zh-CN">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<meta name="description" content="å®‰å…¨ã€å¿«é€Ÿã€ç®€å•çš„å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“å·¥å…·" />
		<title>å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“</title>
		<link
			rel="icon"
			href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸš€</text></svg>"
		>
		<style>
      :root {
        --primary: #3b82f6;
        --primary-hover: #2563eb;
        --secondary: #f8fafc;
        --accent: #10b981;
        --accent-hover: #059669;
        --danger: #ef4444;
        --warning: #f59e0b;
        --text-primary: #1f2937;
        --text-secondary: #6b7280;
        --text-light: #9ca3af;
        --border: #e5e7eb;
        --border-light: #f3f4f6;
        --surface: #ffffff;
        --surface-elevated: #ffffff;
        --shadow-sm: 0 1px 2px 0 rgb(0 0 0 / 0.05);
        --shadow-md: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        --radius: 8px;
        --radius-lg: 12px;
      }

      * {
        box-sizing: border-box;
        margin: 0;
        padding: 0;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Helvetica Neue', sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        line-height: 1.6;
        color: var(--text-primary);
        padding: 1rem;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        animation: fadeIn 0.6s ease-out;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .header {
        background: var(--surface);
        padding: 2rem;
        border-radius: var(--radius-lg);
        margin-bottom: 1.5rem;
        box-shadow: var(--shadow-lg);
        text-align: center;
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .header h1 {
        font-size: clamp(1.5rem, 4vw, 2.5rem);
        font-weight: 700;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 0.5rem;
      }

      .header p {
        color: var(--text-secondary);
        font-size: 1.1rem;
        max-width: 600px;
        margin: 0 auto;
      }

      .main-grid {
        display: grid;
        grid-template-columns: 1fr 2fr;
        gap: 1.5rem;
        align-items: start;
      }

      .panel {
        background: var(--surface);
        border-radius: var(--radius-lg);
        padding: 1.5rem;
        box-shadow: var(--shadow-lg);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
        transition: all 0.3s ease;
      }

      .panel:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
      }

      .panel h2 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .panel h2::before {
        content: '';
        width: 4px;
        height: 1.5rem;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        border-radius: 2px;
      }

      .panel h3 {
        font-size: 1.1rem;
        font-weight: 600;
        margin: 1.5rem 0 0.75rem 0;
        color: var(--text-primary);
      }

      .input-group {
        margin-bottom: 1.5rem;
      }

      .input-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 500;
        color: var(--text-primary);
        font-size: 0.9rem;
      }

      .input-group input {
        width: 100%;
        padding: 0.75rem 1rem;
        border: 2px solid var(--border);
        border-radius: var(--radius);
        font-size: 1rem;
        transition: all 0.2s ease;
        background: var(--surface);
      }

      .input-group input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
      }

      .button {
        width: 100%;
        padding: 0.75rem 1.5rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius);
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        margin-top: 0.75rem;
        transition: all 0.2s ease;
        position: relative;
        overflow: hidden;
      }

      .button::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
        transition: left 0.5s;
      }

      .button:hover::before {
        left: 100%;
      }

      .button:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
        box-shadow: var(--shadow-md);
      }

      .button:active {
        transform: translateY(0);
      }

      .button:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }

      .button.primary {
        background: var(--accent);
      }

      .button.primary:hover {
        background: var(--accent-hover);
      }

      .id-section {
        margin-bottom: 1.5rem;
      }

      .id-card {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
        border: 1px solid var(--border);
        border-radius: var(--radius);
        padding: 1rem;
        transition: all 0.3s ease;
      }

      .id-card.active-id {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.05));
        border-color: var(--accent);
      }

      .id-card-header {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
        color: var(--text-secondary);
        font-weight: 500;
      }

      .id-icon {
        font-size: 1rem;
      }

      .id-input-wrapper, .id-display-wrapper {
        display: flex;
        gap: 0.5rem;
        align-items: center;
      }

      .id-input {
        flex: 1;
        padding: 0.5rem 0.75rem;
        border: 1px solid var(--border);
        border-radius: calc(var(--radius) / 1.5);
        font-size: 0.9rem;
        transition: all 0.2s ease;
        background: var(--surface);
      }

      .id-input:focus {
        outline: none;
        border-color: var(--primary);
        box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
      }

      .current-id {
        flex: 1;
        font-size: 1.1rem;
        font-weight: 600;
        background: linear-gradient(135deg, var(--primary), var(--accent));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .id-btn {
        padding: 0.5rem 1rem;
        border: none;
        border-radius: calc(var(--radius) / 1.5);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 60px;
        background: var(--primary);
        color: white;
      }

      .id-btn:hover {
        background: var(--primary-hover);
        transform: translateY(-1px);
      }

      .id-btn.secondary {
        background: var(--text-light);
        color: var(--text-primary);
      }

      .id-btn.secondary:hover {
        background: var(--text-secondary);
        color: white;
      }

      .list-container {
        max-height: 300px;
        overflow-y: auto;
        overflow-x: hidden;
        border-radius: var(--radius);
        border: 1px solid var(--border-light);
      }

      .list-container::-webkit-scrollbar {
        width: 6px;
      }

      .list-container::-webkit-scrollbar-track {
        background: var(--border-light);
        border-radius: 3px;
      }

      .list-container::-webkit-scrollbar-thumb {
        background: var(--text-light);
        border-radius: 3px;
      }

      .list-container::-webkit-scrollbar-thumb:hover {
        background: var(--text-secondary);
      }

      .device-item, .online-user-item {
        padding: 1rem;
        border-bottom: 1px solid var(--border-light);
        cursor: pointer;
        transition: all 0.2s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }

      .device-item:last-child, .online-user-item:last-child {
        border-bottom: none;
      }

      .device-item:hover, .online-user-item:hover {
        background: var(--secondary);
        transform: translateX(4px);
      }

      .device-item.selected {
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(16, 185, 129, 0.1));
        border-left: 4px solid var(--primary);
      }

      .online-user-item.self {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(34, 197, 94, 0.1));
        border-left: 4px solid var(--accent);
      }

      .connect-btn-small {
        padding: 0.5rem 1rem;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: calc(var(--radius) / 2);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 500;
        transition: all 0.2s ease;
        min-width: 70px;
      }

      .connect-btn-small:hover {
        background: var(--primary-hover);
        transform: scale(1.05);
      }

      .connect-btn-small:disabled {
        background: var(--text-light);
        cursor: not-allowed;
        transform: none;
      }

      .drop-zone {
        border: 2px dashed var(--border);
        border-radius: var(--radius-lg);
        padding: 3rem 2rem;
        text-align: center;
        margin-bottom: 1.5rem;
        transition: all 0.3s ease;
        background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.8));
        cursor: pointer;
      }

      .drop-zone:hover, .drop-zone.active {
        border-color: var(--primary);
        background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(16, 185, 129, 0.05));
        transform: scale(1.02);
      }

      .drop-zone-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.7;
      }

      .drop-zone p {
        margin: 0.5rem 0;
      }

      .drop-zone .primary-text {
        font-size: 1.2rem;
        font-weight: 600;
        color: var(--text-primary);
      }

      .drop-zone .secondary-text {
        color: var(--text-secondary);
      }

      .drop-zone .paste-hint {
        color: var(--text-light);
        font-size: 0.8rem;
        margin-top: 0.5rem;
        opacity: 0.8;
        transition: all 0.3s ease;
      }

      .drop-zone .paste-hint kbd {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border: 1px solid #adb5bd;
        border-bottom: 2px solid #6c757d;
        border-radius: 4px;
        padding: 0.2rem 0.4rem;
        font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', monospace;
        font-size: 0.75rem;
        font-weight: 600;
        color: #495057;
        margin: 0 0.1rem;
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        display: inline-block;
        min-width: 1.5rem;
        text-align: center;
        position: relative;
        top: -1px;
        transition: all 0.15s ease;
        user-select: none;
      }

      .drop-zone .paste-hint kbd:hover {
        background: linear-gradient(135deg, #ffffff 0%, #f1f3f4 100%);
        transform: translateY(-0.5px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
      }

      /* æ·±è‰²æ¨¡å¼ä¸‹çš„ kbd æ ·å¼ */
      @media (prefers-color-scheme: dark) {
        .drop-zone .paste-hint kbd {
          background: linear-gradient(135deg, #495057 0%, #343a40 100%);
          border: 1px solid #6c757d;
          border-bottom: 2px solid #adb5bd;
          color: #f8f9fa;
          box-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        .drop-zone .paste-hint kbd:hover {
          background: linear-gradient(135deg, #5a6268 0%, #3d4449 100%);
          transform: translateY(-0.5px);
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
        }
      }

      .file-list {
        max-height: 400px;
        overflow-y: auto;
        border-radius: var(--radius);
      }

      .file-item {
        background: var(--surface);
        padding: 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 1rem;
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--border-light);
        transition: all 0.2s ease;
      }

      .file-item:hover {
        box-shadow: var(--shadow-md);
        transform: translateY(-1px);
      }

      .file-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.75rem;
        flex-direction: column;
      }

      .file-name {
        font-weight: 600;
        color: var(--text-primary);
        word-break: break-word;
      }

      .file-size {
        color: var(--text-secondary);
        font-size: 0.9rem;
        margin-left: 0.5rem;
      }

      .file-status {
        font-size: 0.9rem;
        font-weight: 500;
        white-space: nowrap;
      }

      .file-info {
        font-size: 0.85rem;
        color: var(--text-secondary);
        margin: 0.75rem 0;
        display: flex;
        flex-wrap: wrap;
        gap: 1rem;
      }

      .file-progress {
        height: 6px;
        background: var(--border-light);
        border-radius: 3px;
        overflow: hidden;
        margin-top: 0.75rem;
      }

      .file-progress-bar {
        height: 100%;
        background: linear-gradient(90deg, var(--primary), var(--accent));
        transition: width 0.3s ease;
        border-radius: 3px;
      }

      .info-box {
        background: linear-gradient(135deg, rgba(251, 191, 36, 0.1), rgba(245, 158, 11, 0.1));
        border: 1px solid rgba(245, 158, 11, 0.3);
        color: var(--text-primary);
        padding: 1.5rem;
        border-radius: var(--radius);
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
      }

      .info-box strong {
        color: var(--warning);
      }

      .info-box ol {
        margin-top: 0.75rem;
        margin-left: 1.5rem;
      }

      .info-box li {
        margin: 0.25rem 0;
      }

      .empty-state {
        text-align: center;
        color: var(--text-light);
        padding: 2rem;
        font-style: italic;
      }

      .notification {
        position: fixed;
        top: 1rem;
        right: 1rem;
        z-index: 1000;
        padding: 1rem 1.5rem;
        border-radius: var(--radius);
        color: white;
        font-weight: 500;
        box-shadow: var(--shadow-lg);
        animation: slideIn 0.3s ease-out;
      }

      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }

      .notification.success {
        background: var(--accent);
      }

      .notification.error {
        background: var(--danger);
      }

      .status-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 0.5rem;
      }

      .status-indicator.online {
        background: var(--accent);
      }

      .status-indicator.offline {
        background: var(--text-light);
      }

      /* è§¦æ‘¸è®¾å¤‡ä¼˜åŒ– */
      @media (hover: none) and (pointer: coarse) {
        .button, .connect-btn-small {
          min-height: 44px; /* iOS æ¨èçš„æœ€å°è§¦æ‘¸ç›®æ ‡ */
        }
        
        .device-item, .online-user-item {
          min-height: 44px;
        }
      }

      /* å“åº”å¼è®¾è®¡ */
      @media (max-width: 768px) {
        body {
          padding: 0.5rem;
        }

        .main-grid {
          grid-template-columns: 1fr;
          gap: 1rem;
        }

        .header {
          padding: 1.5rem;
          margin-bottom: 1rem;
        }

        .panel {
          padding: 1rem;
        }

        .id-card {
          padding: 0.75rem;
        }

        .id-input-wrapper, .id-display-wrapper {
          flex-direction: column;
          gap: 0.5rem;
          align-items: stretch;
        }

        .id-btn {
          align-self: stretch;
        }

        .drop-zone {
          padding: 2rem 1rem;
        }

        .drop-zone-icon {
          font-size: 2rem;
        }

        .file-header {
          flex-direction: column;
          align-items: flex-start;
          gap: 0.5rem;
        }

        .file-info {
          flex-direction: column;
          gap: 0.25rem;
        }

        .device-item, .online-user-item {
          padding: 0.75rem;
        }

        .notification {
          top: 0.5rem;
          right: 0.5rem;
          left: 0.5rem;
          margin: 0;
        }
      }

      @media (max-width: 480px) {
        .header h1 {
          font-size: 1.5rem;
        }

        .panel h2 {
          font-size: 1.25rem;
        }

        .button {
          padding: 0.875rem 1.5rem;
        }

        .drop-zone {
          padding: 1.5rem 1rem;
        }

        .file-item {
          padding: 1rem;
        }
      }

      /* æ·±è‰²æ¨¡å¼æ”¯æŒ */
      @media (prefers-color-scheme: dark) {
        :root {
          --surface: #1f2937;
          --surface-elevated: #374151;
          --text-primary: #f9fafb;
          --text-secondary: #d1d5db;
          --text-light: #9ca3af;
          --border: #374151;
          --border-light: #4b5563;
          --secondary: #374151;
        }

        body {
          background: linear-gradient(135deg, #1f2937 0%, #111827 100%);
        }

        .panel, .header {
          background: rgba(31, 41, 55, 0.8);
          border: 1px solid rgba(75, 85, 99, 0.3);
        }

        .file-item {
          background: var(--surface-elevated);
        }

        .drop-zone {
          background: linear-gradient(135deg, rgba(31, 41, 55, 0.8), rgba(55, 65, 81, 0.8));
        }

        .id-card {
          background: rgba(55, 65, 81, 0.5);
          border-color: var(--border);
        }

        .id-card.active-id {
          background: rgba(16, 185, 129, 0.15);
          border-color: var(--accent);
        }

        .id-input {
          background: var(--surface-elevated);
          border-color: var(--border);
          color: var(--text-primary);
        }
      }
    </style>
	</head>
	<body>
		<div class="container">
			<div class="header">
				<h1>ğŸš€ å±€åŸŸç½‘æ–‡ä»¶ä¼ è¾“</h1>
				<p>å®‰å…¨ã€å¿«é€Ÿã€ç®€å•çš„ç‚¹å¯¹ç‚¹æ–‡ä»¶ä¼ è¾“å·¥å…·</p>
			</div>

			<div class="main-grid">
				<div class="panel">
					<h2>ğŸ”— è¿æ¥è®¾ç½®</h2>

					<div class="info-box">
						<strong>ğŸ’¡ ä½¿ç”¨è¯´æ˜ï¼š</strong>
						<ol>
							<li>è®¾ç½®æ‚¨çš„ IDï¼ˆID åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œæ¨ªçº¿ï¼‰</li>
							<li>åœ¨"åœ¨çº¿ç”¨æˆ·"åˆ—è¡¨ä¸­ç‚¹å‡»è¿æ¥æŒ‰é’®</li>
							<li>è¿æ¥æˆåŠŸåå³å¯ä¼ è¾“æ–‡ä»¶</li>
						</ol>
					</div>

					<!-- ID ç®¡ç†åŒºåŸŸ -->
					<div class="id-section">
						<div id="idSetupCard" class="id-card">
							<!-- <div class="id-card-header">
                <span class="id-icon">ğŸ‘¤</span>
                <span>è®¾ç½®æ‚¨çš„èº«ä»½ID</span>
              </div> -->
							<div class="id-input-wrapper">
								<input
									type="text"
									id="myIdInput"
									placeholder="è¾“å…¥æ‚¨çš„ ID (å¦‚: alice)"
									maxlength="20"
									class="id-input"
								>
								<button id="setIdBtn" class="id-btn">è®¾ç½®</button>
							</div>
						</div>

						<div
							id="idDisplayCard"
							class="id-card active-id"
							style="display: none"
						>
							<!-- <div class="id-card-header">
                <span class="id-icon">âœ…</span>
                <span>å½“å‰èº«ä»½</span>
              </div> -->
							<div class="id-display-wrapper">
								<div class="current-id" id="myIdText"></div>
								<button id="changeIdBtn" class="id-btn secondary">ä¿®æ”¹</button>
							</div>
						</div>
					</div>

					<!-- åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ -->
					<h3>ğŸ‘¥ åœ¨çº¿ç”¨æˆ·</h3>
					<div class="list-container">
						<div id="onlineUsersList">
							<div class="empty-state">æ­£åœ¨è·å–åœ¨çº¿ç”¨æˆ·...</div>
						</div>
					</div>

					<!-- å·²è¿æ¥çš„ç”¨æˆ·åˆ—è¡¨ -->
					<h3>âœ… å·²è¿æ¥çš„ç”¨æˆ·</h3>
					<div class="list-container">
						<div id="deviceList">
							<div class="empty-state">å°šæœªè¿æ¥ä»»ä½•ç”¨æˆ·</div>
						</div>
					</div>
				</div>

				<div class="panel">
					<h2>ğŸ“ æ–‡ä»¶ä¼ è¾“</h2>

					<div id="dropZone" class="drop-zone">
						<div class="drop-zone-icon">ğŸ“¤</div>
						<p class="primary-text">æ‹–æ‹½æ–‡ä»¶åˆ°è¿™é‡Œ</p>
						<p class="secondary-text">æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</p>
						<p class="paste-hint" id="pasteHint">ä¹Ÿå¯ä»¥æŒ‰ Ctrl+V ç²˜è´´æ–‡ä»¶</p>
						<input type="file" id="fileInput" multiple style="display: none" />
					</div>

					<h3>ğŸ“‹ ä¼ è¾“åˆ—è¡¨</h3>
					<div class="file-list" id="fileList">
						<div class="empty-state">æš‚æ— æ–‡ä»¶ä¼ è¾“</div>
					</div>
				</div>
			</div>
		</div>

		<script type="module">
      import { P2PManagerWS } from './p2p-manager-ws.js'
      import { config, updateConfigFromURL } from './config.js'

      // æ›´æ–°é…ç½®ï¼ˆä» URL å‚æ•°ï¼‰
      updateConfigFromURL()

      const manager = new P2PManagerWS()
      let selectedDevice = null
      const devices = new Map()
      const onlineUsers = new Set()

      // DOM å…ƒç´ 
      const myIdInput = document.getElementById('myIdInput')
      const setIdBtn = document.getElementById('setIdBtn')
      const changeIdBtn = document.getElementById('changeIdBtn')
      const idSetupCard = document.getElementById('idSetupCard')
      const idDisplayCard = document.getElementById('idDisplayCard')
      const myIdText = document.getElementById('myIdText')
      const deviceList = document.getElementById('deviceList')
      const onlineUsersList = document.getElementById('onlineUsersList')
      const dropZone = document.getElementById('dropZone')
      const fileInput = document.getElementById('fileInput')
      const fileList = document.getElementById('fileList')

      // ç³»ç»Ÿæ£€æµ‹å·¥å…·å‡½æ•°
      function detectOS() {
        const userAgent = navigator.userAgent.toLowerCase()
        return {
          isMac: userAgent.includes('mac') || userAgent.includes('darwin'),
          isIOS: /ipad|iphone|ipod/.test(userAgent),
          isWindows: userAgent.includes('win'),
          isLinux: userAgent.includes('linux') && !userAgent.includes('android'),
          isAndroid: userAgent.includes('android')
        }
      }

      // æ£€æµ‹æ“ä½œç³»ç»Ÿå¹¶æ›´æ–°å¿«æ·é”®æç¤º
      function updatePasteHint() {
        const pasteHint = document.getElementById('pasteHint')
        if (!pasteHint) return
        
        const os = detectOS()
        
        let description = 'ç²˜è´´æ–‡ä»¶'
        
        if (os.isMac && !os.isIOS) {
          pasteHint.innerHTML = `ä¹Ÿå¯ä»¥æŒ‰ <kbd>âŒ˜</kbd>+<kbd>V</kbd> ${description}`
        } else if (os.isIOS) {
          // iOSè®¾å¤‡ä¸æ”¯æŒæ–‡ä»¶ç²˜è´´ï¼Œæç¤ºä¸åŒå†…å®¹
          pasteHint.innerHTML = 'æˆ–ä» <strong>ç…§ç‰‡</strong> åº”ç”¨é•¿æŒ‰ç²˜è´´å›¾ç‰‡'
          pasteHint.style.opacity = '0.7'
          pasteHint.style.fontSize = '0.75rem'
        } else if (os.isAndroid) {
          // Androidè®¾å¤‡çš„ç²˜è´´åŠŸèƒ½æœ‰é™
          pasteHint.innerHTML = 'æˆ–ä½¿ç”¨ <strong>åˆ†äº«</strong> åŠŸèƒ½ä¼ è¾“æ–‡ä»¶'
          pasteHint.style.opacity = '0.7'
          pasteHint.style.fontSize = '0.75rem'
        } else {
          // Windows/Linux
          pasteHint.innerHTML = `ä¹Ÿå¯ä»¥æŒ‰ <kbd>Ctrl</kbd>+<kbd>V</kbd> ${description}`
        }
      }

      // åˆå§‹åŒ–
      async function init() {
        // ä½¿ç”¨é…ç½®æ–‡ä»¶ä¸­çš„ä¿¡ä»¤æœåŠ¡å™¨åœ°å€
        const success = await manager.init(config.signalServer)

        if (!success) {
          const error = document.createElement('div')
          error.className = 'notification error'
          error.style.position = 'relative'
          error.style.top = 'auto'
          error.style.right = 'auto'
          error.style.marginBottom = '1rem'
          error.innerHTML = `<strong>âŒ é”™è¯¯ï¼š</strong>æ— æ³•è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨<br>
            è¯·ç¡®ä¿ï¼š<br>
            1. è¿è¡Œäº† WebSocket ä¿¡ä»¤æœåŠ¡å™¨ï¼š<code>node ws-signal-server.js</code><br>
            2. åœ¨ config.js ä¸­é…ç½®äº†æ­£ç¡®çš„æœåŠ¡å™¨åœ°å€<br>
            3. æˆ–ä½¿ç”¨ URL å‚æ•°ï¼š<code>?server=[IP]:3001</code>`
          document.querySelector('.header').appendChild(error)
          return
        }

        if (config.signalServer) {
          // æ˜¾ç¤ºè¿æ¥ä¿¡æ¯
          // const info = document.createElement('div')
          // info.style.cssText =
          //   'background: #e3f2fd; padding: 10px; margin-bottom: 10px; border-radius: 5px;'
          // info.innerHTML = `<strong>å·²è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨</strong>ï¼š${config.signalServer}<br>
          //   å…¶ä»–è®¾å¤‡è¯·è®¿é—®ç›¸åŒçš„åœ°å€æˆ–é…ç½®ç›¸åŒçš„æœåŠ¡å™¨`
          // document.querySelector('.header').appendChild(info)
          console.log('å·²è¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨', config.signalServer)
        }

        // æ›´æ–°å¿«æ·é”®æç¤º
        updatePasteHint()
        
        // è¾“å‡ºç³»ç»Ÿæ£€æµ‹ä¿¡æ¯ï¼ˆç”¨äºè°ƒè¯•ï¼‰
        const os = detectOS()
        console.log('ğŸ” ç³»ç»Ÿæ£€æµ‹ç»“æœ:', {
          ç³»ç»Ÿç±»å‹: os.isMac ? 'macOS' : os.isWindows ? 'Windows' : os.isLinux ? 'Linux' : os.isAndroid ? 'Android' : os.isIOS ? 'iOS' : 'æœªçŸ¥',
          å¿«æ·é”®: os.isMac && !os.isIOS ? 'âŒ˜+V' : 'Ctrl+V',
          HTMLç»“æ„: os.isMac && !os.isIOS ? '<kbd>âŒ˜</kbd>+<kbd>V</kbd>' : '<kbd>Ctrl</kbd>+<kbd>V</kbd>',
          æ”¯æŒç²˜è´´: !(os.isIOS || os.isAndroid),
          ç”¨æˆ·ä»£ç†: navigator.userAgent
        })

        // æ£€æŸ¥æ˜¯å¦å·²æœ‰ä¿å­˜çš„ ID
        const savedId = localStorage.getItem('myP2PId')
        if (savedId) {
          myIdInput.value = savedId
          setMyId()
        }
      }

      // è®¾ç½®æˆ‘çš„ ID
      setIdBtn.onclick = setMyId
      changeIdBtn.onclick = () => {
        idDisplayCard.style.display = 'none'
        idSetupCard.style.display = 'block'
        myIdInput.focus()
      }

      // å›è½¦é”®è®¾ç½®ID
      myIdInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          setMyId()
        }
      })

      async function setMyId() {
        const myId = myIdInput.value.trim().toLowerCase()
        if (!myId) {
          alert('è¯·è¾“å…¥ä¸€ä¸ªæœ‰æ•ˆçš„ ID')
          return
        }

        if (!/^[a-z0-9_-]+$/i.test(myId)) {
          alert('ID åªèƒ½åŒ…å«å­—æ¯ã€æ•°å­—ã€ä¸‹åˆ’çº¿å’Œæ¨ªçº¿')
          return
        }

        // è®¾ç½®åŠ è½½çŠ¶æ€
        setIdBtn.disabled = true
        const originalText = setIdBtn.textContent
        setIdBtn.textContent = 'è®¾ç½®ä¸­...'

        try {
          // å¦‚æœæ˜¯ä¿®æ”¹IDï¼Œå…ˆæ–­å¼€æ‰€æœ‰è¿æ¥
          const isChangingId = manager.myId && manager.myId !== myId
          if (isChangingId) {
          const oldId = manager.myId
          console.log(`æ­£åœ¨ä¿®æ”¹ID: ${oldId} -> ${myId}`)
          
          // ç«‹å³æ¸…ç†å‰ç«¯çŠ¶æ€
          devices.clear()
          deviceList.innerHTML = '<div class="empty-state">å°šæœªè¿æ¥ä»»ä½•ç”¨æˆ·</div>'
          selectedDevice = null
          
          // ä»åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ä¸­ç§»é™¤æ—§IDï¼ˆå¦‚æœå­˜åœ¨ï¼‰
          onlineUsers.delete(oldId)
          
          // æ–­å¼€æ‰€æœ‰è¿æ¥
          manager.disconnectAll()
          
          // å…ˆæ³¨é”€æ—§IDå¹¶ç­‰å¾…ç¡®è®¤
          try {
            await manager.unregisterUser()
            console.log('æ—§IDæ³¨é”€æˆåŠŸ')
          } catch (error) {
            console.warn('æ³¨é”€æ—§IDå¤±è´¥ï¼Œç»§ç»­æ‰§è¡Œ:', error.message)
          }
          
          // æ³¨é”€å®Œæˆåç«‹å³è¿›è¡Œåç»­æ“ä½œ
          // é‡æ–°è¿æ¥WebSocketä»¥ç¡®ä¿æœåŠ¡å™¨çŠ¶æ€æ¸…ç†ï¼ˆè·³è¿‡è‡ªåŠ¨æ³¨å†Œæ—§IDï¼‰
          await manager.reconnectWebSocket(true)
          
          // è®¾ç½®æ–°ID
          manager.setMyId(myId)
          localStorage.setItem('myP2PId', myId)
          
          console.log(`IDå·²æ›´æ–°ä¸º: ${myId}`)
          
          // æ›´æ–°ç•Œé¢æ˜¾ç¤º
          myIdText.textContent = myId
          idSetupCard.style.display = 'none'
          idDisplayCard.style.display = 'block'
          
          // æ˜¾ç¤ºæˆåŠŸé€šçŸ¥
          const notification = document.createElement('div')
          notification.className = 'notification success'
          notification.innerHTML = `âœ… ID å·²æ›´æ–°ä¸º ${myId}ï¼Œæ‰€æœ‰è¿æ¥å·²æ–­å¼€`
          document.body.appendChild(notification)
          
          setTimeout(() => {
            if (document.body.contains(notification)) {
              document.body.removeChild(notification)
            }
          }, 3000)
          
          // æœåŠ¡å™¨ä¼šåœ¨ç”¨æˆ·ä¸Šçº¿æ—¶è‡ªåŠ¨æ¨é€åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼Œæ— éœ€ä¸»åŠ¨è·å–
          
          return // æå‰è¿”å›ï¼Œé¿å…é‡å¤è®¾ç½®
        }

        manager.setMyId(myId)
        localStorage.setItem('myP2PId', myId)

                  myIdText.textContent = myId
          idSetupCard.style.display = 'none'
          idDisplayCard.style.display = 'block'

          // æœåŠ¡å™¨ä¼šåœ¨ç”¨æˆ·æ³¨å†ŒæˆåŠŸåè‡ªåŠ¨æ¨é€åœ¨çº¿ç”¨æˆ·åˆ—è¡¨ï¼Œæ— éœ€ä¸»åŠ¨è·å–
        } catch (error) {
          console.error('è®¾ç½®IDå¤±è´¥:', error)
          alert('è®¾ç½®IDå¤±è´¥: ' + error.message)
        } finally {
          // æ¢å¤æŒ‰é’®çŠ¶æ€
          setIdBtn.disabled = false
          setIdBtn.textContent = originalText
        }
      }

      // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨æ˜¾ç¤º
      function updateOnlineUsersList() {
        if (onlineUsers.size === 0 && !manager.myId) {
          onlineUsersList.innerHTML = '<div class="empty-state">è¯·å…ˆè®¾ç½®æ‚¨çš„ ID</div>'
          return
        }

        if (onlineUsers.size === 0) {
          onlineUsersList.innerHTML = '<div class="empty-state">æš‚æ— å…¶ä»–åœ¨çº¿ç”¨æˆ·</div>'
          return
        }

        onlineUsersList.innerHTML = ''
        for (const userId of onlineUsers) {
          const userDiv = document.createElement('div')
          userDiv.className = 'online-user-item'
          
          const isConnected = devices.has(userId)
          
          userDiv.innerHTML = `
            <span>
              <span class="status-indicator ${isConnected ? 'online' : 'offline'}"></span>
              <strong>${userId}</strong>${isConnected ? ' (å·²è¿æ¥)' : ''}
            </span>
            <button class="connect-btn-small" ${isConnected ? 'disabled' : ''} 
                    onclick="connectToUser('${userId}')">
              ${isConnected ? 'å·²è¿æ¥' : 'è¿æ¥'}
            </button>
          `
          onlineUsersList.appendChild(userDiv)
        }
      }

      // è¿æ¥åˆ°æŒ‡å®šç”¨æˆ·
      window.connectToUser = async (userId) => {
        if (!manager.myId) {
          alert('è¯·å…ˆè®¾ç½®æ‚¨è‡ªå·±çš„ ID')
          return
        }

        if (userId === manager.myId) {
          alert('ä¸èƒ½è¿æ¥åˆ°è‡ªå·±')
          return
        }

        // ç¦ç”¨æ‰€æœ‰è¿æ¥æŒ‰é’®
        const connectButtons = onlineUsersList.querySelectorAll('.connect-btn-small')
        connectButtons.forEach(btn => btn.disabled = true)

        try {
          await manager.connectToPeer(userId)

          // æ·»åŠ åˆ°è®¾å¤‡åˆ—è¡¨
          const device = { id: userId, name: userId }
          if (!devices.has(userId)) {
            devices.set(userId, device)
            addDeviceToList(device)
          }

          updateOnlineUsersList() // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨çŠ¶æ€
        } catch (error) {
          console.error('è¿æ¥å¤±è´¥:', error)
          alert(`è¿æ¥åˆ° ${userId} å¤±è´¥: ${error.message}`)
        } finally {
          updateOnlineUsersList() // é‡æ–°å¯ç”¨æŒ‰é’®
        }
      }

      // æ·»åŠ è®¾å¤‡åˆ°åˆ—è¡¨
      function addDeviceToList(device) {
        if (deviceList.children[0]?.classList.contains('empty-state')) {
          deviceList.innerHTML = ''
        }

        const div = document.createElement('div')
        div.className = 'device-item'
        div.innerHTML = `
          <span>
            <span class="status-indicator online"></span>
            <strong>${device.name}</strong>
          </span>
        `
        div.onclick = () => selectDevice(device, div)
        deviceList.appendChild(div)

        // è‡ªåŠ¨é€‰ä¸­
        div.click()
      }

      // é€‰æ‹©è®¾å¤‡
      function selectDevice(device, element) {
        deviceList.querySelectorAll('.device-item').forEach((item) => {
          item.classList.remove('selected')
        })

        element.classList.add('selected')
        selectedDevice = device
      }

      // æ–‡ä»¶ä¼ è¾“ç›¸å…³ä»£ç ...
      dropZone.onclick = () => fileInput.click()

      dropZone.ondragover = (e) => {
        e.preventDefault()
        dropZone.classList.add('active')
      }

      dropZone.ondragleave = () => {
        dropZone.classList.remove('active')
      }

      dropZone.ondrop = (e) => {
        e.preventDefault()
        dropZone.classList.remove('active')
        
        // æ£€æŸ¥æ˜¯å¦æ”¯æŒæ–‡ä»¶å¤¹æ‹–æ‹½
        const items = e.dataTransfer.items
        if (items) {
          console.log('[æ‹–æ‹½è°ƒè¯•] DataTransferItemsæ•°é‡:', items.length)
          
          // æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶å¤¹
          let hasFolder = false
          for (let i = 0; i < items.length; i++) {
            const item = items[i]
            if (item.kind === 'file') {
              const entry = item.webkitGetAsEntry?.() || item.getAsEntry?.()
              if (entry && entry.isDirectory) {
                hasFolder = true
                console.log('[æ‹–æ‹½è°ƒè¯•] æ£€æµ‹åˆ°æ–‡ä»¶å¤¹:', entry.name)
              }
            }
          }
          
          if (hasFolder) {
            alert('æ£€æµ‹åˆ°æ–‡ä»¶å¤¹ï¼\n\nç”±äºæµè§ˆå™¨å®‰å…¨é™åˆ¶ï¼Œæš‚æ—¶æ— æ³•å¤„ç†æ–‡ä»¶å¤¹ä¼ è¾“ã€‚\nè¯·é€‰æ‹©æ–‡ä»¶å¤¹å†…çš„å…·ä½“æ–‡ä»¶è¿›è¡Œä¼ è¾“ã€‚')
            return
          }
        }
        
        handleFiles(e.dataTransfer.files)
      }

      fileInput.onchange = (e) => {
        handleFiles(e.target.files)
      }

      // æ£€æµ‹æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹çš„è¾…åŠ©å‡½æ•°
      function isLikelyFolder(file) {
        const os = detectOS()
        
        // æ£€æµ‹æ–‡ä»¶å¤¹çš„ç‰¹å¾
        const hasNoExtension = !file.name.includes('.')
        const hasZeroSize = file.size === 0
        const hasNoType = !file.type || file.type === ''
        const hasDirectoryPath = file.name.endsWith('/') || file.name.endsWith('\\')
        const hasDirectoryType = file.type === 'application/x-directory'
        
        // Macç³»ç»Ÿç‰¹æ®Šå¤„ç†ï¼šæ–‡ä»¶å¤¹é€šå¸¸æœ‰å°çš„éé›¶å¤§å°ï¼ˆå…ƒæ•°æ®å¤§å°ï¼‰
        const isMacSmallSize = os.isMac && file.size > 0 && file.size < 4096 // é€šå¸¸å°äº4KB
        
        // Macæ–‡ä»¶å¤¹çš„å…¸å‹ç‰¹å¾ï¼š
        // 1. å¤§å°é€šå¸¸æ˜¯ 68, 96, 102, 204, 238, 272, 306, 340, 374, 408ç­‰ï¼ˆFinderä¿¡æ¯å¤§å°ï¼‰
        // 2. å¸¸è§çš„æ–‡ä»¶å¤¹å¤§å°èŒƒå›´
        const isMacTypicalFolderSize = os.isMac && file.size > 0 && (
          file.size === 68 || file.size === 96 || file.size === 102 || 
          file.size === 204 || file.size === 238 || file.size === 272 || 
          file.size === 306 || file.size === 340 || file.size === 374 || 
          file.size === 408 || (file.size > 60 && file.size < 500 && file.size % 34 === 0)
        )
        
        // å¸¸è§çš„æ— æ‰©å±•åæ–‡ä»¶ï¼Œä¸åº”è¢«è¯¯åˆ¤ä¸ºæ–‡ä»¶å¤¹
        const commonNoExtFiles = [
          'README', 'LICENSE', 'CHANGELOG', 'Dockerfile', 'Makefile', 
          '.gitignore', '.env', '.eslintrc', '.prettierrc', 'COPYING',
          'AUTHORS', 'CONTRIBUTORS', 'INSTALL', 'NEWS', 'TODO'
        ]
        const isCommonFile = commonNoExtFiles.some(name => 
          file.name.toUpperCase() === name.toUpperCase() || 
          (file.name.startsWith('.') && file.name.length > 1)
        )
        
        // æ£€æŸ¥æ˜¯å¦ä¸ºå¯æ‰§è¡Œæ–‡ä»¶æˆ–è„šæœ¬ï¼ˆè¿™äº›é€šå¸¸æ²¡æœ‰æ‰©å±•åä½†æ˜¯æ–‡ä»¶ï¼‰
        const isLikelyExecutable = file.size > 4096 && hasNoExtension && hasNoType
        
        // Macç³»ç»Ÿçš„æœ€ç»ˆæ–‡ä»¶å¤¹åˆ¤æ–­
        const isMacFolder = os.isMac && hasNoExtension && hasNoType && (isMacSmallSize || isMacTypicalFolderSize)
        
        // æœ€ç»ˆçš„æ–‡ä»¶å¤¹åˆ¤æ–­
        const isFolderResult = !isCommonFile && !isLikelyExecutable && (
          hasDirectoryType || 
          hasDirectoryPath ||
          (hasNoExtension && hasZeroSize && hasNoType) ||
          isMacFolder
        )
        
        console.log(`[æ–‡ä»¶å¤¹æ£€æµ‹] ${file.name}:`, {
          åŸºæœ¬ä¿¡æ¯: {
            hasNoExtension,
            hasZeroSize,
            hasNoType,
            fileSize: file.size,
            ç³»ç»Ÿ: os.isMac ? 'Mac' : 'Other'
          },
          ç‰¹å¾æ£€æµ‹: {
            hasDirectoryPath,
            hasDirectoryType,
            isMacSmallSize,
            isMacTypicalFolderSize,
            isMacFolder
          },
          æ’é™¤æ¡ä»¶: {
            isCommonFile,
            isLikelyExecutable
          },
          æœ€ç»ˆåˆ¤æ–­: isFolderResult
        })
        
        // å¦‚æœæ£€æµ‹ä¸ºMacæ–‡ä»¶å¤¹ï¼Œç»™å‡ºé¢å¤–æç¤º
        if (os.isMac && isMacFolder) {
          console.log(`[Macæ–‡ä»¶å¤¹] æ£€æµ‹åˆ°Macç³»ç»Ÿæ–‡ä»¶å¤¹: ${file.name} (${file.size}å­—èŠ‚)`)
        }
        
        return isFolderResult
      }

      // æ˜¾ç¤ºæ–‡ä»¶å¤¹ç²˜è´´è­¦å‘Š
      function showFolderPasteWarning(folderNames) {
        const notification = document.createElement('div')
        notification.className = 'notification error'
        notification.innerHTML = `
          <strong>âš ï¸ ä¸æ”¯æŒç²˜è´´æ–‡ä»¶å¤¹</strong><br>
          æ£€æµ‹åˆ°æ–‡ä»¶å¤¹: ${folderNames.join(', ')}<br>
          <small>ğŸ’¡ å»ºè®®ï¼šè¯·ç›´æ¥æ‹–æ‹½æ–‡ä»¶å¤¹åˆ°ä¼ è¾“åŒºåŸŸï¼Œæˆ–é€‰æ‹©æ–‡ä»¶å¤¹å†…çš„æ–‡ä»¶</small>
        `
        document.body.appendChild(notification)
        
        setTimeout(() => {
          if (document.body.contains(notification)) {
            document.body.removeChild(notification)
          }
        }, 5000) // æ˜¾ç¤º5ç§’
      }

      // ç²˜è´´æ–‡ä»¶æ”¯æŒ
      document.addEventListener('paste', (e) => {
        e.preventDefault()
        
        const clipboardData = e.clipboardData || window.clipboardData
        if (!clipboardData) return
        
        const items = clipboardData.items
        const files = []
        const folders = []
        
        console.log('[ç²˜è´´è°ƒè¯•] å‰ªè´´æ¿é¡¹ç›®æ•°é‡:', items.length)
        
        // éå†å‰ªè´´æ¿é¡¹ç›®
        for (let i = 0; i < items.length; i++) {
          const item = items[i]
          
          console.log(`[ç²˜è´´è°ƒè¯•] é¡¹ç›®${i}:`, {
            kind: item.kind,
            type: item.type,
            toString: item.toString?.()
          })
          
          // æ£€æŸ¥æ˜¯å¦æ˜¯æ–‡ä»¶
          if (item.kind === 'file') {
            const file = item.getAsFile()
            if (file) {
              console.log(`[ç²˜è´´è°ƒè¯•] è·å–åˆ°æ–‡ä»¶:`, {
                name: file.name,
                size: file.size,
                type: file.type,
                lastModified: file.lastModified,
                isLikelyFolder: isLikelyFolder(file)
              })
              
              // æ£€æµ‹æ˜¯å¦ä¸ºæ–‡ä»¶å¤¹
              if (isLikelyFolder(file)) {
                folders.push(file.name)
                console.log(`[ç²˜è´´è°ƒè¯•] æ£€æµ‹åˆ°ç–‘ä¼¼æ–‡ä»¶å¤¹: ${file.name}`)
              } else {
                files.push(file)
              }
            }
          }
        }
        
        // å¤„ç†æ£€æµ‹åˆ°çš„æ–‡ä»¶å¤¹
        if (folders.length > 0) {
          console.log(`[ç²˜è´´è°ƒè¯•] å‘ç° ${folders.length} ä¸ªæ–‡ä»¶å¤¹:`, folders)
          showFolderPasteWarning(folders)
          
          // å¦‚æœåŒæ—¶æœ‰æ–‡ä»¶ï¼Œè¯¢é—®ç”¨æˆ·æ˜¯å¦ç»§ç»­å¤„ç†æ–‡ä»¶
          if (files.length > 0) {
            const proceed = confirm(`æ£€æµ‹åˆ° ${folders.length} ä¸ªæ–‡ä»¶å¤¹å’Œ ${files.length} ä¸ªæ–‡ä»¶ã€‚\n\næ–‡ä»¶å¤¹æ— æ³•é€šè¿‡ç²˜è´´ä¼ è¾“ï¼Œæ˜¯å¦ç»§ç»­ä¼ è¾“å…¶ä¸­çš„æ–‡ä»¶ï¼Ÿ`)
            if (!proceed) {
              return
            }
          } else {
            // åªæœ‰æ–‡ä»¶å¤¹ï¼Œæ²¡æœ‰æ–‡ä»¶
            return
          }
        }
        
        if (files.length > 0) {
          console.log(`[ç²˜è´´è°ƒè¯•] å‡†å¤‡å¤„ç† ${files.length} ä¸ªæ–‡ä»¶:`, files.map(f => ({
            name: f.name,
            size: f.size,
            type: f.type
          })))
          
          // æ˜¾ç¤ºç²˜è´´æç¤ºåŠ¨ç”»
          dropZone.classList.add('active')
          setTimeout(() => {
            dropZone.classList.remove('active')
          }, 200)
          
          handleFiles(files)
        } else {
          // æ£€æŸ¥æ˜¯å¦æœ‰å…¶ä»–æ–‡ä»¶æ ¼å¼ï¼ˆå¦‚Windowså¤åˆ¶çš„æ–‡ä»¶ï¼‰
          const filesList = clipboardData.files
          if (filesList && filesList.length > 0) {
            console.log(`[ç²˜è´´è°ƒè¯•] ä»clipboardData.filesæ£€æµ‹åˆ°æ–‡ä»¶:`, Array.from(filesList).map(f => ({
              name: f.name,
              size: f.size,
              type: f.type,
              isLikelyFolder: isLikelyFolder(f)
            })))
            
            // å¯¹clipboardData.filesä¹Ÿè¿›è¡Œæ–‡ä»¶å¤¹æ£€æµ‹
            const validFiles = []
            const detectedFolders = []
            
            for (const file of filesList) {
              if (isLikelyFolder(file)) {
                detectedFolders.push(file.name)
              } else {
                validFiles.push(file)
              }
            }
            
            if (detectedFolders.length > 0) {
              showFolderPasteWarning(detectedFolders)
            }
            
            if (validFiles.length > 0) {
              handleFiles(validFiles)
            }
          } else {
            console.log('[ç²˜è´´è°ƒè¯•] å‰ªè´´æ¿ä¸­æ²¡æœ‰æ£€æµ‹åˆ°ä»»ä½•æ–‡ä»¶')
          }
        }
      })

      // æ˜¾ç¤ºç²˜è´´é”®ç›˜å¿«æ·é”®æç¤º
      document.addEventListener('keydown', (e) => {
        const os = detectOS()
        
        // æ£€æµ‹æ­£ç¡®çš„å¿«æ·é”®ç»„åˆ
        const isCorrectShortcut = os.isMac && !os.isIOS ? 
          (e.metaKey && e.key === 'v') : // Mac: Cmd+V
          (e.ctrlKey && e.key === 'v')   // Windows/Linux: Ctrl+V
        
        if (isCorrectShortcut) {
          // é«˜äº®æ˜¾ç¤ºç²˜è´´æç¤º
          const pasteHint = document.querySelector('.paste-hint')
          const kbdElements = pasteHint?.querySelectorAll('kbd')
          
          if (pasteHint && kbdElements && kbdElements.length > 0) {
            // é«˜äº®æ•´ä¸ªæç¤ºæ–‡å­—
            pasteHint.style.color = 'var(--primary)'
            pasteHint.style.opacity = '1'
            pasteHint.style.fontWeight = '600'
            
            // æ‰€æœ‰é”®ç›˜æŒ‰é”®æŒ‰ä¸‹æ•ˆæœ
            kbdElements.forEach(kbd => {
              kbd.style.transform = 'translateY(1px)'
              kbd.style.boxShadow = '0 0 4px rgba(66, 165, 245, 0.4)'
              kbd.style.borderBottomWidth = '1px'
            })
            
            setTimeout(() => {
              pasteHint.style.color = ''
              pasteHint.style.opacity = ''
              pasteHint.style.fontWeight = ''
              
              // æ¢å¤æ‰€æœ‰é”®ç›˜æŒ‰é”®æ ·å¼
              kbdElements.forEach(kbd => {
                kbd.style.transform = ''
                kbd.style.boxShadow = ''
                kbd.style.borderBottomWidth = ''
              })
            }, 1000)
          }
        }
      })

      async function handleFiles(files) {
        if (!selectedDevice) {
          alert('è¯·å…ˆé€‰æ‹©ä¸€ä¸ªç”¨æˆ·')
          return
        }

        for (const file of files) {
          await sendFile(file)
        }
      }

      async function sendFile(file) {
        const fileItem = createFileItem(file)
        fileItem.dataset.fileSize = file.size // å­˜å‚¨æ–‡ä»¶å¤§å°
        if (fileList.children[0]?.classList.contains('empty-state')) {
          fileList.innerHTML = ''
        }
        fileList.appendChild(fileItem)

        try {
          const startTime = Date.now()
          await manager.sendFile(selectedDevice.id, file, (progressData) => {
            updateFileProgress(fileItem, progressData.progress, progressData.completedChunks, progressData.totalChunks)
          })

          const elapsed = (Date.now() - startTime) / 1000
          fileItem.querySelector('.file-status').textContent = `âœ… å‘é€å®Œæˆ (è€—æ—¶: ${elapsed.toFixed(1)}ç§’)`
          fileItem.querySelector('.file-info').style.display = 'none'
        } catch (error) {
          console.error('å‘é€å¤±è´¥:', error)
          const errorMsg = error.message || 'æœªçŸ¥é”™è¯¯'
          const currentProgress = fileItem.querySelector('.file-progress-bar').style.width
          fileItem.querySelector('.file-status').innerHTML = 
            `âŒ å‘é€å¤±è´¥: ${errorMsg} (å·²å®Œæˆ ${currentProgress})`
          fileItem.querySelector('.file-status').style.color = 'var(--danger)'
          fileItem.querySelector('.file-info').style.display = 'none'
          fileItem.querySelector('.file-progress').style.display = 'none'
        }
      }

      function createFileItem(file) {
        const div = document.createElement('div')
        div.className = 'file-item'
        div.innerHTML = `
          <div class="file-header">
            <div>
              <div class="file-name">ğŸ“„ ${file.name}</div>
              <span class="file-size">(${formatSize(file.size)})</span>
            </div>
            <span class="file-status">â³ å‘é€ä¸­...</span>
          </div>
          <div class="file-info">
            <span class="transfer-speed"></span>
            <span class="transfer-time"></span>
          </div>
          <div class="file-progress">
            <div class="file-progress-bar" style="width: 0%"></div>
          </div>
        `
        div.startTime = Date.now()
        div.lastUpdate = Date.now()
        div.lastBytes = 0
        return div
      }

      function createReceivingFileItem(metadata, fromId) {
        const div = document.createElement('div')
        div.className = 'file-item'
        div.innerHTML = `
          <div class="file-header">
            <div>
              <div class="file-name">ğŸ“¥ ${metadata.name}</div>
              <span class="file-size">(${formatSize(metadata.size)})</span>
            </div>
            <span class="file-status">â¬‡ï¸ ä» ${fromId} æ¥æ”¶ä¸­...</span>
          </div>
          <div class="file-info">
            <span class="transfer-speed"></span>
            <span class="transfer-time"></span>
          </div>
          <div class="file-progress">
            <div class="file-progress-bar" style="width: 0%"></div>
          </div>
        `
        return div
      }

      function updateFileProgress(fileItem, progress, completedChunks, totalChunks) {
        const progressBar = fileItem.querySelector('.file-progress-bar')
        if (progressBar) {
          progressBar.style.width = `${progress * 100}%`
        }

        // è®¡ç®—ä¼ è¾“é€Ÿåº¦å’Œæ—¶é—´
        const now = Date.now()
        const elapsed = (now - fileItem.startTime) / 1000
        const currentBytes = progress * parseInt(fileItem.dataset.fileSize || 0)
        
        if (now - fileItem.lastUpdate > 500) { // æ¯500msæ›´æ–°ä¸€æ¬¡é€Ÿåº¦
          const bytesPerSecond = (currentBytes - fileItem.lastBytes) / ((now - fileItem.lastUpdate) / 1000)
          const speed = formatSize(bytesPerSecond) + '/s'
          
          let statusText = `é€Ÿåº¦: ${speed} | å·²ç”¨æ—¶: ${elapsed.toFixed(1)}ç§’`
          // if (completedChunks !== undefined && totalChunks !== undefined) {
          //   statusText += ` | å—: ${completedChunks}/${totalChunks}`
          // }
          
          fileItem.querySelector('.transfer-speed').textContent = statusText
          fileItem.querySelector('.transfer-time').textContent = ''
          
          fileItem.lastUpdate = now
          fileItem.lastBytes = currentBytes
        }
      }

      function updateReceivingFileProgress(fileInfo, progress, receivedChunks, totalChunks) {
        const fileItem = fileInfo.item
        const progressBar = fileItem.querySelector('.file-progress-bar')
        if (progressBar) {
          progressBar.style.width = `${progress * 100}%`
        }

        // è®¡ç®—ä¼ è¾“é€Ÿåº¦å’Œæ—¶é—´
        const now = Date.now()
        const elapsed = (now - fileInfo.startTime) / 1000
        const currentBytes = progress * fileInfo.metadata.size
        
        if (!fileInfo.lastUpdate || now - fileInfo.lastUpdate > 500) { // æ¯500msæ›´æ–°ä¸€æ¬¡é€Ÿåº¦
          const bytesPerSecond = fileInfo.lastUpdate ? 
            (currentBytes - (fileInfo.lastBytes || 0)) / ((now - fileInfo.lastUpdate) / 1000) : 0
          const speed = formatSize(bytesPerSecond) + '/s'
          
          // ä¼°è®¡å‰©ä½™æ—¶é—´
          const remainingBytes = fileInfo.metadata.size - currentBytes
          const eta = bytesPerSecond > 0 ? remainingBytes / bytesPerSecond : 0
          
          let statusText = `é€Ÿåº¦: ${speed} | å·²ç”¨æ—¶: ${elapsed.toFixed(1)}ç§’`
          if (eta > 0) {
            statusText += ` | å‰©ä½™: ${eta.toFixed(1)}ç§’`
          }
          // if (receivedChunks !== undefined && totalChunks !== undefined) {
          //   statusText += ` | å—: ${receivedChunks}/${totalChunks}`
          // }
          
          fileItem.querySelector('.transfer-speed').textContent = statusText
          fileItem.querySelector('.transfer-time').textContent = ''
          
          fileInfo.lastUpdate = now
          fileInfo.lastBytes = currentBytes
        }
      }

      function formatSize(bytes) {
        const sizes = ['B', 'KB', 'MB', 'GB']
        if (bytes === 0) return '0 B'
        const i = Math.floor(Math.log(bytes) / Math.log(1024))
        return (
          Math.round((bytes / Math.pow(1024, i)) * 100) / 100 + ' ' + sizes[i]
        )
      }

      // ç›‘å¬æ–‡ä»¶æ¥æ”¶è¿›åº¦
      const receivingFiles = new Map() // å­˜å‚¨æ¥æ”¶ä¸­çš„æ–‡ä»¶ä¿¡æ¯

      // ç›‘å¬æ–‡ä»¶å¼€å§‹æ¥æ”¶
      manager.onFileStart = (metadata, fromId) => {
        const fileItem = createReceivingFileItem(metadata, fromId)
        
        if (fileList.children[0]?.classList.contains('empty-state')) {
          fileList.innerHTML = ''
        }
        fileList.appendChild(fileItem)

        // è®°å½•æ¥æ”¶ä¿¡æ¯
        receivingFiles.set(metadata.id, {
          item: fileItem,
          startTime: Date.now(),
          metadata: metadata,
          fromId: fromId
        })
      }

      // ç›‘å¬æ–‡ä»¶æ¥æ”¶è¿›åº¦
      manager.onFileProgress = (data) => {
        const fileInfo = receivingFiles.get(data.id)
        if (fileInfo) {
          updateReceivingFileProgress(fileInfo, data.progress, data.receivedChunks, data.totalChunks)
        }
      }

      // ç›‘å¬æ–‡ä»¶æ¥æ”¶å®Œæˆ
      manager.onFileReceived = (file, fromId) => {
        // æŸ¥æ‰¾å¯¹åº”çš„æ¥æ”¶é¡¹
        let fileInfo = null
        for (const [id, info] of receivingFiles) {
          if (info.metadata.name === file.name && info.fromId === fromId) {
            fileInfo = info
            receivingFiles.delete(id)
            break
          }
        }

        if (fileInfo) {
          // æ›´æ–°ä¸ºå®ŒæˆçŠ¶æ€
          const elapsed = (Date.now() - fileInfo.startTime) / 1000
          fileInfo.item.querySelector('.file-status').innerHTML = 
            `âœ… æ¥æ”¶å®Œæˆ (è€—æ—¶: ${elapsed.toFixed(1)}ç§’)`
          fileInfo.item.querySelector('.file-progress').style.display = 'none'
        }
      }

      // ç›‘å¬æ–‡ä»¶ä¼ è¾“å¤±è´¥
      manager.onFileFailed = (failedInfo, fromId) => {
        console.log('[UI-DEBUG] æ–‡ä»¶ä¼ è¾“å¤±è´¥:', {
          fileId: failedInfo.id,
          fileName: failedInfo.name,
          reason: failedInfo.reason,
          progress: failedInfo.progress,
          fromId: fromId,
          hasFileInfo: receivingFiles.has(failedInfo.id),
          timestamp: new Date().toISOString()
        })
        
        const fileInfo = receivingFiles.get(failedInfo.id)
        if (fileInfo) {
          receivingFiles.delete(failedInfo.id)
          
          // æ›´æ–°ä¸ºå¤±è´¥çŠ¶æ€
          const progressPercent = (failedInfo.progress * 100).toFixed(1)
          fileInfo.item.querySelector('.file-status').innerHTML = 
            `âŒ ä¼ è¾“å¤±è´¥: ${failedInfo.reason} (å·²å®Œæˆ ${progressPercent}%)`
          fileInfo.item.querySelector('.file-status').style.color = 'var(--danger)'
          fileInfo.item.querySelector('.file-progress').style.display = 'none'
          fileInfo.item.querySelector('.file-info').style.display = 'none'
        }
      }

      // ç›‘å¬æ–°è¿æ¥
      manager.onPeerConnected = (peerId) => {
        console.log('[UI-DEBUG] P2Pè¿æ¥å»ºç«‹æˆåŠŸ:', {
          peerId: peerId,
          alreadyInDevices: devices.has(peerId),
          currentDevices: Array.from(devices.keys()),
          timestamp: new Date().toISOString()
        })
        
        const device = { id: peerId, name: peerId }
        if (!devices.has(peerId)) {
          devices.set(peerId, device)
          addDeviceToList(device)
        }
        updateOnlineUsersList() // æ›´æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
      }

      // ç›‘å¬åœ¨çº¿ç”¨æˆ·åˆ—è¡¨
      manager.onUsersListReceived = (users) => {
        console.log('[UI-DEBUG] æ”¶åˆ°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨:', {
          receivedUsers: users,
          previousOnlineUsers: Array.from(onlineUsers),
          timestamp: new Date().toISOString()
        })
        
        onlineUsers.clear()
        users.forEach(userId => onlineUsers.add(userId))
        
        console.log('[UI-DEBUG] æ›´æ–°åçš„åœ¨çº¿ç”¨æˆ·:', Array.from(onlineUsers))
        updateOnlineUsersList()
      }

      // ç›‘å¬æ–°ç”¨æˆ·ä¸Šçº¿
      manager.onUserOnline = (userId) => {
        if (userId !== manager.myId) {
          onlineUsers.add(userId)
          updateOnlineUsersList()
        }
      }

      // ç›‘å¬ç”¨æˆ·ç¦»çº¿
      manager.onUserOffline = (userId) => {
        console.log(`[UI-DEBUG] æ”¶åˆ°ç”¨æˆ·ç¦»çº¿äº‹ä»¶:`, {
          userId: userId,
          wasOnline: onlineUsers.has(userId),
          wasConnected: devices.has(userId),
          currentOnlineUsers: Array.from(onlineUsers),
          currentConnectedDevices: Array.from(devices.keys()),
          timestamp: new Date().toISOString()
        })
        
        onlineUsers.delete(userId)
        
        // å¦‚æœè¯¥ç”¨æˆ·å·²è¿æ¥ï¼Œä»è®¾å¤‡åˆ—è¡¨ä¸­ç§»é™¤
        if (devices.has(userId)) {
          console.log(`[UI-DEBUG] ç”¨æˆ· ${userId} å·²è¿æ¥ï¼Œä»è®¾å¤‡åˆ—è¡¨ä¸­ç§»é™¤`)
          devices.delete(userId)
          // æ›´æ–°å·²è¿æ¥è®¾å¤‡åˆ—è¡¨
          updateDeviceList()
        }
        
        updateOnlineUsersList()
        console.log('[UI-DEBUG] ç”¨æˆ·ç¦»çº¿å¤„ç†å®Œæˆï¼Œå½“å‰çŠ¶æ€:', {
          onlineUsers: Array.from(onlineUsers),
          connectedDevices: Array.from(devices.keys())
        })
      }

      // æ›´æ–°å·²è¿æ¥è®¾å¤‡åˆ—è¡¨
      function updateDeviceList() {
        if (devices.size === 0) {
          deviceList.innerHTML = '<div class="empty-state">å°šæœªè¿æ¥ä»»ä½•ç”¨æˆ·</div>'
          selectedDevice = null
        } else {
          deviceList.innerHTML = ''
          let firstDevice = null
          for (const [id, device] of devices) {
            const div = document.createElement('div')
            div.className = 'device-item'
            div.innerHTML = `
              <span>
                <span class="status-indicator online"></span>
                <strong>${device.name}</strong>
              </span>
            `
            div.onclick = () => selectDevice(device, div)
            deviceList.appendChild(div)
            
            if (!firstDevice) {
              firstDevice = { device, element: div }
            }
          }
          
          // å¦‚æœå½“å‰é€‰ä¸­çš„è®¾å¤‡å·²ç¦»çº¿ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªè®¾å¤‡
          if (selectedDevice && !devices.has(selectedDevice.id) && firstDevice) {
            firstDevice.element.click()
          }
        }
      }

      // å®šæœŸåˆ·æ–°åœ¨çº¿ç”¨æˆ·åˆ—è¡¨


      // é¡µé¢å¸è½½æ—¶æ¸…ç†
      window.addEventListener('beforeunload', () => {
        manager.cleanup()
      })

      // å¯åŠ¨
      init()
    </script>
	</body>
</html>
