# 并行文件传输实现说明

## 功能概述

文件传输已从顺序传输改为并行传输多个块，提高了传输效率。

### 主要改进

1. **并行传输**：同时发送最多 5 个文件块（可配置）
2. **乱序接收**：接收端可以按任意顺序接收块，最后正确重组
3. **进度显示**：显示已完成的块数和总块数
4. **更高效率**：充分利用带宽，减少等待时间

## 技术实现

### 发送端

1. **文件分块**
   ```javascript
   const chunkSize = 64 * 1024 // 64KB
   const totalChunks = Math.ceil(file.size / chunkSize)
   ```

2. **并行控制**
   - 最大并发数：5 个块（可在 config.js 中配置）
   - 动态管理活跃的传输任务
   - 使用 Promise.race 等待任意传输完成

3. **消息协议**
   - `file-start`：包含文件元数据和总块数
   - `file-chunk-with-data`：每个块的数据（包含块索引、大小和实际数据）
   - `file-end`：标记传输完成

### 接收端

1. **预分配数组**
   ```javascript
   chunks: new Array(metadata.totalChunks)
   ```

2. **按索引存储**
   - 根据块索引将数据存储到正确位置
   - 支持乱序接收

3. **完整性检查**
   - 验证是否收到所有块
   - 检查块大小是否匹配

## 配置选项

在 `config.js` 中可以调整：

```javascript
options: {
  // 文件传输块大小（字节）
  chunkSize: 64 * 1024, // 64KB
  
  // 最大并发传输块数
  maxConcurrentChunks: 5,
}
```

## 用户界面

传输时显示：
- 传输速度
- 已用时间和剩余时间
- 块进度：如 "块: 15/30"

## 性能优势

1. **更高吞吐量**：并行传输充分利用可用带宽
2. **更低延迟**：减少等待时间
3. **更好的用户体验**：更快的传输速度和详细的进度信息

## 错误处理

- 连接断开时，所有活跃的传输任务会被取消
- 如果文件块不完整，会显示具体的失败原因
- 支持断点续传的基础架构（未来可扩展） 